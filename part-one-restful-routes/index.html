<!DOCTYPE html>
<html>
<head>
  <title>Test Driven Development Courses</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link
    rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/materialize/0.97.3/css/materialize.min.css"
  >
  <link href="//fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
  <link href="/assets/css/styles.css" rel="stylesheet">
  <script
    src="//code.jquery.com/jquery-2.2.4.min.js"
    integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
    crossorigin="anonymous"
  ></script>
  <script
    type="text/javascript"
    src="/assets/js/main.js"
  ></script>
</head>
<body>

  <nav class="red darken-1">
    <div class="container">
      <div class="hide-on-small-and-down">
        <h3 class="brand-logo"><a href="/">Test Driven Development Courses</a></h3>
      </div>
      <div class="hide-on-med-and-up">
        <h3 class="brand-logo"><a href="/">TDD Courses</a></h3>
      </div>
    </div>
  </nav>

  <br>

  <div class="container">
    <div class="row">
      <div class="col m3 hide-on-small-and-down">
        <br>
        <div id="toc-block" class="collection hide-on-small-and-down">
          <ul class="collapsible collapsible-accordion">
            
              
                <li>
                  <h5 data-part="1" class="collapsible-header  waves-effect waves-teal">
                    Part 1
                  </h5>
                  <div class="collapsible-body">
              
              <ul>
                <li>
                  <a
                    class="collection-item"
                    href="/part-one-intro"
                  >Introduction</a>
                </li>
              </ul>
            
              
              <ul>
                <li>
                  <a
                    class="collection-item"
                    href="/part-one-getting-started"
                  >Getting Started</a>
                </li>
              </ul>
            
              
              <ul>
                <li>
                  <a
                    class="collection-item"
                    href="/part-one-docker-config"
                  >Docker Config</a>
                </li>
              </ul>
            
              
              <ul>
                <li>
                  <a
                    class="collection-item"
                    href="/part-one-postgres-setup"
                  >Postgres Setup</a>
                </li>
              </ul>
            
              
              <ul>
                <li>
                  <a
                    class="collection-item"
                    href="/part-one-test-setup"
                  >Test Setup</a>
                </li>
              </ul>
            
              
              <ul>
                <li>
                  <a
                    class="collection-item"
                    href="/part-one-flask-blueprints"
                  >Flask Blueprints</a>
                </li>
              </ul>
            
              
              <ul>
                <li>
                  <a
                    class="collection-item"
                    href="/part-one-restful-routes"
                  >RESTful Routes</a>
                </li>
              </ul>
            
              
              <ul>
                <li>
                  <a
                    class="collection-item"
                    href="/part-one-aws-deployment"
                  >Deployment</a>
                </li>
              </ul>
            
              
              <ul>
                <li>
                  <a
                    class="collection-item"
                    href="/part-one-jinja-templates"
                  >Jinja Templates</a>
                </li>
              </ul>
            
              
              <ul>
                <li>
                  <a
                    class="collection-item"
                    href="/part-one-workflow"
                  >Workflow</a>
                </li>
              </ul>
            
              
                <li>
                  <h5 data-part="2" class="collapsible-header  waves-effect waves-teal">
                    Part 2
                  </h5>
                  <div class="collapsible-body">
              
              <ul>
                <li>
                  <a
                    class="collection-item"
                    href="/part-two-intro"
                  >Introduction</a>
                </li>
              </ul>
            
          </div>
        </li>
          </ul>
        </div>
      </div>
      <div class="col m9">


<h2>RESTful Routes</h2>
<p>Next, let&#39;s set up three new routes, following RESTful best practices, with TDD:</p>

<table><thead>
<tr>
<th>Endpoint</th>
<th>HTTP Method</th>
<th>CRUD Method</th>
<th>Result</th>
</tr>
</thead><tbody>
<tr>
<td>/names</td>
<td>GET</td>
<td>READ</td>
<td>get all names</td>
</tr>
<tr>
<td>/names/:id</td>
<td>GET</td>
<td>READ</td>
<td>get single name</td>
</tr>
<tr>
<td>/names</td>
<td>POST</td>
<td>CREATE</td>
<td>add a name</td>
</tr>
</tbody></table>

<p>For each, we&#39;ll-</p>

<ol>
<li>write a test</li>
<li>watch the test fail</li>
<li>write just enough code to get the test to pass</li>
<li>refactor (if necessary)</li>
</ol>

<p>Let&#39; start with the POST route...</p>

<h4 id="post">POST</h4>

<p>Add the test to <em>services/names/project/tests/test_user.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">test_add_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ensure a new name can be added to the database.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s">&#39;/names&#39;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s">&#39;Michael&#39;</span><span class="p">)),</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">201</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;Michael was added!&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;success&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">])</span>
</code></pre></div>
<p>Run the test to ensure it fails:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>docker-compose run names-service python manage.py <span class="nb">test</span>
</code></pre></div>
<p>Then add the route handler to <em>services/names/project/api/views.py</em></p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="nd">@names_blueprint.route</span><span class="p">(</span><span class="s">&#39;/names&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">add_name</span><span class="p">():</span>
    <span class="n">post_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">post_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;text&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Name</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">))</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;success&#39;</span><span class="p">,</span>
        <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="n">f</span><span class="s">&#39;{text} was added!&#39;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">)),</span> <span class="mi">201</span>
</code></pre></div>
<p>Update the imports as well:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Blueprint</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">make_response</span>

<span class="kn">from</span> <span class="nn">project.api.models</span> <span class="kn">import</span> <span class="n">Name</span>
<span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">db</span>
</code></pre></div>
<p>Run tests. They all should pass:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">Ran <span class="m">5</span> tests in 0.201s

OK
</code></pre></div>
<p>What about errors and exceptions? Like:</p>

<ol>
<li>A payload is not sent</li>
<li>The payload is invalid - i.e., the JSON object is empty or it contains the wrong keys</li>
<li>The name already exists in the database</li>
</ol>

<p>Add some tests:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">test_add_name_invalid_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ensure error is thrown if the JSON object is empty.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s">&#39;/names&#39;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">()),</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;Invalid payload.&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;fail&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">test_add_name_invalid_json_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ensure error is thrown if the JSON objectdoes not have a text key.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s">&#39;/names&#39;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">incorrect</span><span class="o">=</span><span class="s">&#39;Michael&#39;</span><span class="p">)),</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;Invalid payload.&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;fail&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">test_add_name_duplicate_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ensure error is thrown if the name already exists.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s">&#39;/names&#39;</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s">&#39;Michael&#39;</span><span class="p">)),</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s">&#39;/names&#39;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s">&#39;Michael&#39;</span><span class="p">)),</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;Name already exists&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;fail&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">])</span>
</code></pre></div>
<p>Ensure they fail, and then update the route handler:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="nd">@names_blueprint.route</span><span class="p">(</span><span class="s">&#39;/names&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">add_name</span><span class="p">():</span>
    <span class="n">post_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">post_data</span><span class="p">:</span>
        <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;fail&#39;</span><span class="p">,</span>
            <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;Invalid payload.&#39;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">)),</span> <span class="mi">400</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">post_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;text&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;fail&#39;</span><span class="p">,</span>
            <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;Invalid payload.&#39;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">)),</span> <span class="mi">400</span>
    <span class="n">new_text</span> <span class="o">=</span> <span class="n">Name</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">new_text</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Name</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">))</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;success&#39;</span><span class="p">,</span>
            <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="n">f</span><span class="s">&#39;{text} was added!&#39;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">)),</span> <span class="mi">201</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;fail&#39;</span><span class="p">,</span>
            <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;Name already exists.&#39;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">)),</span> <span class="mi">400</span>
</code></pre></div>
<p>Ensure the tests pass, and then move on to the next route...</p>

<h4 id="get-single-name">GET single name</h4>

<p>Start with the a test:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">test_single_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ensure get single name behaves correctly.&quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Name</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s">&#39;Michael&#39;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="s">&#39;/names/{name.id}&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s">&#39;created_date&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;Michael&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">][</span><span class="s">&#39;name&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;success&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">])</span>
</code></pre></div>
<p>Add the following imports:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">project.api.models</span> <span class="kn">import</span> <span class="n">Name</span>
</code></pre></div>
<p>Ensure the test breaks before writing the view:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="nd">@names_blueprint.route</span><span class="p">(</span><span class="s">&#39;/names/&lt;name_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_single_name</span><span class="p">(</span><span class="n">name_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get single name details&quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Name</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">name_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;success&#39;</span><span class="p">,</span>
        <span class="s">&#39;data&#39;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
          <span class="s">&#39;created_date&#39;</span><span class="p">:</span> <span class="n">name</span><span class="o">.</span><span class="n">created_date</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">)),</span> <span class="mi">200</span>
</code></pre></div>
<p>The tests should pass. Now, what about error handling?</p>

<ol>
<li>An id is not provided</li>
<li>The id does not exist</li>
</ol>

<p>Tests:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">test_single_name_no_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ensure error is thrown if an id is not provided.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;/names/blah&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">404</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;Name does not exist&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;fail&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">test_single_name_incorrect_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ensure error is thrown if the id does not exist.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;/names/999&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">404</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;Name does not exist&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;fail&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">])</span>
</code></pre></div>
<p>Updated view:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="nd">@names_blueprint.route</span><span class="p">(</span><span class="s">&#39;/names/&lt;name_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_single_name</span><span class="p">(</span><span class="n">name_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get single name details&quot;&quot;&quot;</span>
    <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;fail&#39;</span><span class="p">,</span>
        <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;Name does not exist&#39;</span>
    <span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">Name</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">name_id</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">)),</span> <span class="mi">404</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;success&#39;</span><span class="p">,</span>
                <span class="s">&#39;data&#39;</span><span class="p">:</span> <span class="p">{</span>
                  <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
                  <span class="s">&#39;created_date&#39;</span><span class="p">:</span> <span class="n">name</span><span class="o">.</span><span class="n">created_date</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">)),</span> <span class="mi">200</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">)),</span> <span class="mi">404</span>
</code></pre></div>
<h4 id="get-all-names">GET all names</h4>

<p>Again, let&#39;s start with a test. Since we&#39;ll have to add a few names first, let&#39;s add a quick helper function:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">add_name</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Name</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">name</span>
</code></pre></div>
<p>Add this to the top of the <em>services/names/project/tests/test_user.py</em> file, just above the <code>TestNameService()</code> class.</p>

<p>Now, refactor the <em>test_single_name()</em> test, like so:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">test_single_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ensure get single name behaves correctly.&quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">add_name</span><span class="p">(</span><span class="s">&#39;Michael&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="s">&#39;/names/{name.id}&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s">&#39;created_date&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;Michael&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">][</span><span class="s">&#39;name&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;success&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">])</span>
</code></pre></div>
<p>With that, let&#39;s add the new test:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">test_all_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Ensure get all names behaves correctly.&quot;&quot;&quot;</span>
    <span class="n">add_name</span><span class="p">(</span><span class="s">&#39;Michael&#39;</span><span class="p">)</span>
    <span class="n">add_name</span><span class="p">(</span><span class="s">&#39;Fletcher&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;/names&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">][</span><span class="s">&#39;names&#39;</span><span class="p">]),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s">&#39;created_date&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">][</span><span class="s">&#39;names&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s">&#39;created_date&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">][</span><span class="s">&#39;names&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;Michael&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">][</span><span class="s">&#39;names&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;text&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;Fletcher&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">][</span><span class="s">&#39;names&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;text&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;success&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">])</span>
</code></pre></div>
<p>Make sure it fails. Then add the view:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="nd">@names_blueprint.route</span><span class="p">(</span><span class="s">&#39;/names&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_all_names</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Get all names&quot;&quot;&quot;</span>
    <span class="n">names</span> <span class="o">=</span> <span class="n">Name</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">names_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="n">name_object</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">name</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s">&#39;text&#39;</span><span class="p">:</span> <span class="n">name</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
            <span class="s">&#39;created_date&#39;</span><span class="p">:</span> <span class="n">name</span><span class="o">.</span><span class="n">created_date</span>
        <span class="p">}</span>
        <span class="n">names_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name_object</span><span class="p">)</span>
    <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;success&#39;</span><span class="p">,</span>
        <span class="s">&#39;data&#39;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s">&#39;names&#39;</span><span class="p">:</span> <span class="n">names_list</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">)),</span> <span class="mi">200</span>
</code></pre></div>
<p>Does the test past?</p>

<p>Before moving on, let&#39;s test the route in the browser - <a href="http://YOUR-IP:5000/names">http://YOUR-IP:5000/names</a>. So we have some data to work with, add a seed command to the <em>manage.py</em> file to populate the database with some initial data:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="nd">@manager.command</span>
<span class="k">def</span> <span class="nf">seed_db</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Seeds the database.&quot;&quot;&quot;</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Name</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s">&#39;Michael&#39;</span><span class="p">))</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Name</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s">&#39;Jeremy&#39;</span><span class="p">))</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div>
<p>Try it out:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>docker-compose run names-service python manage.py seed_db
</code></pre></div>
<p>Make sure you can view the names in the JSON response <a href="http://YOUR-IP:5000/names">http://YOUR-IP:5000/names</a>.</p>


       </div>
     </div>
   </div>
   <footer class="page-footer white">
    <div class="container footer-container">
      <div class="row">
        <div class="col l6 s12">
          <p class="">Content by Michael Herman (michael@mherman.org)</p>
        </div>
        <div class="col l4 offset-l2 s12">
          <ul>
            <li><a class="" href="http://github.com/mjhea0">Github</a></li>
          </ul>
        </div>
      </div>
    </div>
  </footer>
  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.3/js/materialize.min.js"></script>
</body>
</html>

