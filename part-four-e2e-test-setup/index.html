<!DOCTYPE html>
<html>

  <head>
  
    <title>Microservices with Docker, Flask, and React - End-to-End Test Setup</title>
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link
    rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/materialize/0.97.3/css/materialize.min.css"
  >
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/icon?family=Material+Icons"
  >
  <link
    rel="stylesheet"
    href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
  >
  <link
    href="//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic"
    rel="stylesheet"
    type="text/css"
  >
  <link
    href="//fonts.googleapis.com/css?family=Lato:900,300"
    rel="stylesheet"
    type="text/css"
  >
  <link
    href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css"
    rel="stylesheet"
    type="text/css"
  >
  <link href="/assets/css/styles.css" rel="stylesheet">
  <script
    src="//code.jquery.com/jquery-2.2.4.min.js"
    integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
    crossorigin="anonymous"
  ></script>
  <script
    type="text/javascript"
    src="/assets/js/main.js"
  ></script>
</head>


  <body>

    <nav class="red darken-1">
  <div class="nav-wrapper">
    <a href="/" class="brand-logo center hide-on-small-and-down">
      Test Driven Development Courses
    </a>
    <a href="/" class="brand-logo hide-on-med-and-up">
      TDD Courses
    </a>
    <ul class="right">
      <li class="hide-on-med-and-down">
        <a  href="/course-contents">Contents</a>
      </li>
      <li class="hide-on-large-only">
        <a href="/course-contents">TOC</a>
      </li>
    </ul>
  </div>
</nav>


    <br>

    <div class="container">
      <div class="row">

        <div class="col m3 hide-on-small-and-down">
  <br>
  <div id="toc-block" class="collection hide-on-small-and-down">
    <ul class="collapsible collapsible-accordion">
      
        
          <li>
            <h5 data-part="1" class="collapsible-header  waves-effect waves-teal">
              Part 1
            </h5>
            <div class="collapsible-body">
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-one-intro"
            >Introduction</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-one-getting-started"
            >Getting Started</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-one-docker-config"
            >Docker Config</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-one-postgres-setup"
            >Postgres Setup</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-one-test-setup"
            >Test Setup</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-one-flask-blueprints"
            >Flask Blueprints</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-one-restful-routes"
            >RESTful Routes</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-one-aws-deployment"
            >Deployment</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-one-jinja-templates"
            >Jinja Templates</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-one-workflow"
            >Workflow</a>
          </li>
        </ul>
      
        
          <li>
            <h5 data-part="2" class="collapsible-header  waves-effect waves-teal">
              Part 2
            </h5>
            <div class="collapsible-body">
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-two-intro"
            >Introduction</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-two-project-refactor"
            >Project Refactor</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-two-code-coverage"
            >Code Coverage</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-two-continuous-integration"
            >Continuous Integration</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-two-react-setup"
            >React Setup</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-two-flask-deployment"
            >Flask Deployment</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-two-react-forms"
            >React Forms</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-two-react-docker"
            >React and Docker</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-two-flask-refactor"
            >Flask Refactor</a>
          </li>
        </ul>
      
        
          <li>
            <h5 data-part="3" class="collapsible-header  waves-effect waves-teal">
              Part 3
            </h5>
            <div class="collapsible-body">
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-three-intro"
            >Introduction</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-three-flask-migrate"
            >Flask Migrate</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-three-flask-bcrypt"
            >Flask Bcrypt</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-three-jwt-setup"
            >JWT Setup</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-three-auth-routes"
            >Auth Routes</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-three-react-router"
            >React Router</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-three-react-bootstrap"
            >React Bootstrap</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-three-react-authentication"
            >React Authentication</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-three-authorization"
            >Authorization</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-three-update-component"
            >Update Component</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-three-update-docker"
            >Update Docker</a>
          </li>
        </ul>
      
        
          <li>
            <h5 data-part="4" class="collapsible-header  waves-effect waves-teal">
              Part 4
            </h5>
            <div class="collapsible-body">
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-four-intro"
            >Introduction</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-four-e2e-test-setup"
            >End-to-End Test Setup</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-four-e2e-test-specs"
            >End-to-End Test Specs</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-four-react-component-refactor"
            >React Component Refactor</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-four-react-form-validation"
            >React Form Validation</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-four-react-flash-messages"
            >React Flash Messaging</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-four-swagger-setup"
            >Swagger Setup</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-four-staging-environment"
            >Staging Environment</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-four-workflow"
            >Workflow</a>
          </li>
        </ul>
      
        
          <li>
            <h5 data-part="5" class="collapsible-header  waves-effect waves-teal">
              Part 5
            </h5>
            <div class="collapsible-body">
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-five-intro"
            >Introduction</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-five-docker-hub"
            >Docker Hub</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-five-ec2-container-registry"
            >EC2 Container Registry</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-five-ec2-container-service"
            >EC2 Container Service</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-five-elastic-load-balancing"
            >Elastic Load Balancing</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-five-ec2-container-service-staging"
            >ECS Staging</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-five-ec2-relational-database-service"
            >Relational Database Service</a>
          </li>
        </ul>
      
    </div>
  </li>
    </ul>
  </div>
</div>


        <div class="col m9 hide-on-small-and-down">

          <h2>End-to-End Test Setup</h2>

          <p>In this lesson, we&#39;ll set up e2e testing with TestCafe...</p>

<hr>

<p>Before adding TestCafe into the mix, let&#39;s simplify the running of tests within the <em>flask-microservices-main</em> project.</p>

<p>Start by setting <code>dev</code> as the active machine:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>docker-machine env dev
<span class="nv">$ </span><span class="nb">eval</span> <span class="k">$(</span>docker-machine env dev<span class="k">)</span>
</code></pre></div>
<p>Set the environment variable:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span><span class="nb">export </span><span class="nv">REACT_APP_USERS_SERVICE_URL</span><span class="o">=</span>DOCKER_MACHINE_DEV_IP
</code></pre></div>
<p>Update the containers:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>docker-compose up -d
</code></pre></div>
<p>Ensure the app is working in the browser, and then run the tests:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>docker-compose run users-service python manage.py <span class="nb">test</span>
</code></pre></div>
<p>Once done, add a new file to the project root called <em>test.sh</em>:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c">#!/bin/bash</span>

<span class="nv">fails</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

inspect<span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">[</span> <span class="nv">$1</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">fails</span><span class="o">=</span><span class="s2">&quot;${fails} $2&quot;</span>
  <span class="k">fi</span>
<span class="o">}</span>

docker-compose run users-service python manage.py <span class="nb">test</span>
inspect <span class="nv">$?</span> users-service

<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;${fails}&quot;</span> <span class="o">]</span><span class="p">;</span>
  <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;Tests failed: ${fails}&quot;</span>
    <span class="nb">exit </span>1
  <span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">&quot;Tests passed!&quot;</span>
    <span class="nb">exit </span>0
<span class="k">fi</span>
</code></pre></div>
<p>Here, we run the tests, calculate the number of failures (via the <code>inspect</code> function), and then exit with the proper <a href="http://tldp.org/LDP/abs/html/exitcodes.html">code</a>.</p>

<p>Run the tests to ensure all is well:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>sh test.sh
</code></pre></div>
<p>Update the <code>script</code> in <em>.travis.yml</em>:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">script</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">sh test.sh</span>
</code></pre></div>
<p>Commit and push your code to ensure the tests still pass on Travis.</p>

<h4 id="testcafe">TestCafe</h4>

<p>Unlike the majority of other end-to-end (e2e) testing tools, <a href="https://github.com/DevExpress/testcafe">TestCafe</a> is not dependent on Selenium or WebDriver. Instead, it injects scripts into the browser to communicate directly with the DOM and handle events. It works on any modern browser that supports HTML5 without any plugins.</p>

<blockquote>
<p>Please review the <a href="http://devexpress.github.io/testcafe/documentation/getting-started/">Getting Started</a> guide before beginning.</p>
</blockquote>

<p>To install, first add a <em><a href="https://docs.npmjs.com/files/package.json">package.json</a></em> to the project root:</p>
<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;flask-microservices-main&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p>Then install the dependency:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>npm install testcafe --save
</code></pre></div>
<p>The <code>--save</code> flag adds the dependency info to the <em>package.json</em>:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="o">{</span>
  <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;flask-microservices-main&quot;</span>,
  <span class="s2">&quot;dependencies&quot;</span>: <span class="o">{</span>
    <span class="s2">&quot;testcafe&quot;</span>: <span class="s2">&quot;^0.16.1&quot;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>The dependency (and sub dependencies) were installed to a newly created &quot;node_modules&quot; directory. Add this directory to the <em>.gitignore</em> file.</p>

<p>Let&#39;s write our first test spec!</p>

<h4 id="first-test">First Test</h4>

<p>First, add a new folder to the project root called &quot;e2e&quot;. Then add a new file to that folder called <em>index.test.js</em>:</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Selector</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;testcafe&#39;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">TEST_URL</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">TEST_URL</span><span class="p">;</span>


<span class="nx">fixture</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">).</span><span class="nx">page</span><span class="p">(</span><span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">TEST_URL</span><span class="p">}</span><span class="o">/</span><span class="err">`</span><span class="p">);</span>

<span class="nx">test</span><span class="p">(</span><span class="err">`</span><span class="nx">users</span> <span class="nx">should</span> <span class="nx">be</span> <span class="nx">able</span> <span class="nx">to</span> <span class="nx">view</span> <span class="nx">the</span> <span class="s1">&#39;/&#39;</span> <span class="nx">page</span><span class="err">`</span><span class="p">,</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>

  <span class="nx">await</span> <span class="nx">t</span>
    <span class="p">.</span><span class="nx">navigateTo</span><span class="p">(</span><span class="nx">TEST_URL</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="nx">Selector</span><span class="p">(</span><span class="s1">&#39;H1&#39;</span><span class="p">).</span><span class="nx">withText</span><span class="p">(</span><span class="s1">&#39;All Users&#39;</span><span class="p">).</span><span class="nx">exists</span><span class="p">).</span><span class="nx">ok</span><span class="p">()</span>

<span class="p">});</span>
</code></pre></div>
<p>This test simply navigates to the main URL, <code>/</code>, and then assers that an <code>H1</code> element exists with the text <code>All Users</code>.</p>

<p>Set the environment variable:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span><span class="nb">export </span><span class="nv">TEST_URL</span><span class="o">=</span>DOCKER_MACHINE_DEV_IP
</code></pre></div>
<p>Run the tests:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>testcafe chrome e2e
</code></pre></div>
<p>You should see a new Chrome window open, which navigates to the main page and then TestCafe runs the assertion.</p>

<p>In the terminal, you should see something like:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>testcafe chrome e2e
Using locally installed version of TestCafe.
 Running tests in:
 - Chrome 58.0.3029 / Mac OS X 10.11.6

 /
 users should be able to view the <span class="s1">&#39;/&#39;</span> page


 <span class="m">1</span> passed <span class="o">(</span>1s<span class="o">)</span>
</code></pre></div>
<p>Experiment with this. Try <a href="http://devexpress.github.io/testcafe/documentation/test-api/actions/navigate.html">navigating</a> to a different page. Add a <a href="http://devexpress.github.io/testcafe/documentation/test-api/actions/click.html">click action</a>. Set up additional <a href="http://devexpress.github.io/testcafe/documentation/test-api/selecting-page-elements/selectors.html">selectors</a> and run some more assertions.</p>

<h4 id="ci">CI</h4>

<p>Add the test to the <em>test.sh</em> file:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c">#!/bin/bash</span>

<span class="nv">fails</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

inspect<span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">[</span> <span class="nv">$1</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">fails</span><span class="o">=</span><span class="s2">&quot;${fails} $2&quot;</span>
  <span class="k">fi</span>
<span class="o">}</span>

docker-compose run users-service python manage.py <span class="nb">test</span>
inspect <span class="nv">$?</span> users-service

testcafe chrome e2e
inspect <span class="nv">$?</span> e2e

<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;${fails}&quot;</span> <span class="o">]</span><span class="p">;</span>
  <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;Tests failed: ${fails}&quot;</span>
    <span class="nb">exit </span>1
  <span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">&quot;Tests passed!&quot;</span>
    <span class="nb">exit </span>0
<span class="k">fi</span>
</code></pre></div>
<p>Make sure the tests pass again, and then update <em>.travis.yml</em> like so:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">language</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">node_js</span>
<span class="l-Scalar-Plain">node_js</span><span class="p-Indicator">:</span> <span class="s">&#39;7&#39;</span>

<span class="l-Scalar-Plain">before_install</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">stty cols 80</span>

<span class="l-Scalar-Plain">dist</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">trusty</span>
<span class="l-Scalar-Plain">sudo</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">required</span>

<span class="l-Scalar-Plain">addons</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">apt</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">sources</span><span class="p-Indicator">:</span>
     <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">google-chrome</span>
    <span class="l-Scalar-Plain">packages</span><span class="p-Indicator">:</span>
     <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">google-chrome-stable</span>

<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">docker</span>

<span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">global</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">DOCKER_COMPOSE_VERSION=1.11.2</span>

<span class="l-Scalar-Plain">before_install</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">sudo rm /usr/local/bin/docker-compose</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` &gt; docker-compose</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">chmod +x docker-compose</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">sudo mv docker-compose /usr/local/bin</span>

<span class="l-Scalar-Plain">before_script</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">export TEST_URL=http://127.0.0.1</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">export REACT_APP_USERS_SERVICE_URL=http://127.0.0.1</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">export DISPLAY=:99.0</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">sh -e /etc/init.d/xvfb start</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">sleep 3</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">docker-compose up --build -d</span>

<span class="l-Scalar-Plain">script</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">docker-compose run users-service python manage.py test</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">testcafe chrome e2e/index.test.js</span>

<span class="l-Scalar-Plain">after_script</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">docker-compose down</span>
</code></pre></div>
<p>Here, we added the Node version along with some basic Chrome settings. Also, we have to use <a href="https://docs.travis-ci.com/user/gui-and-headless-browsers/#Using-xvfb-to-Run-Tests-That-Require-a-GUI">xvfb</a> to fake a GUI so that Chrome thinks it&#39;s running in a graphical environment.</p>

<blockquote>
<p>Review the <a href="http://devexpress.github.io/testcafe/documentation/recipes/running-tests-in-firefox-and-chrome-using-travis-ci.html">Running Tests in Firefox and Chrome Using Travis CI</a> for more info.</p>
</blockquote>

<p>Commit your code and push it up to GitHub. Make sure the tests pass on Travis.</p>


          
  <br><br>
  <a class="twitter-share-button" data-show-count="false" href="https://twitter.com/intent/tweet?text=Microservices with Docker, Flask, and React - End-to-End Test Setup&amp;url=http%3A%2F%2Ftestdriven.io/part-four-e2e-test-setup&amp;via=RealPython" rel="nofollow" target="_blank" title="Share on Twitter"></a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>



          <div class="page-nav">
            
              <a class="prev btn left-align" href="/part-four-intro">&laquo; Introduction</a>
            
            
              <a class="next btn right-align" href="/part-four-e2e-test-specs">End-to-End Test Specs &raquo;</a>
            
          </div>

        </div>

        <div class="hide-on-med-and-up">

          <h2>End-to-End Test Setup</h2>

          <p>In this lesson, we&#39;ll set up e2e testing with TestCafe...</p>

<hr>

<p>Before adding TestCafe into the mix, let&#39;s simplify the running of tests within the <em>flask-microservices-main</em> project.</p>

<p>Start by setting <code>dev</code> as the active machine:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>docker-machine env dev
<span class="nv">$ </span><span class="nb">eval</span> <span class="k">$(</span>docker-machine env dev<span class="k">)</span>
</code></pre></div>
<p>Set the environment variable:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span><span class="nb">export </span><span class="nv">REACT_APP_USERS_SERVICE_URL</span><span class="o">=</span>DOCKER_MACHINE_DEV_IP
</code></pre></div>
<p>Update the containers:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>docker-compose up -d
</code></pre></div>
<p>Ensure the app is working in the browser, and then run the tests:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>docker-compose run users-service python manage.py <span class="nb">test</span>
</code></pre></div>
<p>Once done, add a new file to the project root called <em>test.sh</em>:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c">#!/bin/bash</span>

<span class="nv">fails</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

inspect<span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">[</span> <span class="nv">$1</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">fails</span><span class="o">=</span><span class="s2">&quot;${fails} $2&quot;</span>
  <span class="k">fi</span>
<span class="o">}</span>

docker-compose run users-service python manage.py <span class="nb">test</span>
inspect <span class="nv">$?</span> users-service

<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;${fails}&quot;</span> <span class="o">]</span><span class="p">;</span>
  <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;Tests failed: ${fails}&quot;</span>
    <span class="nb">exit </span>1
  <span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">&quot;Tests passed!&quot;</span>
    <span class="nb">exit </span>0
<span class="k">fi</span>
</code></pre></div>
<p>Here, we run the tests, calculate the number of failures (via the <code>inspect</code> function), and then exit with the proper <a href="http://tldp.org/LDP/abs/html/exitcodes.html">code</a>.</p>

<p>Run the tests to ensure all is well:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>sh test.sh
</code></pre></div>
<p>Update the <code>script</code> in <em>.travis.yml</em>:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">script</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">sh test.sh</span>
</code></pre></div>
<p>Commit and push your code to ensure the tests still pass on Travis.</p>

<h4 id="testcafe">TestCafe</h4>

<p>Unlike the majority of other end-to-end (e2e) testing tools, <a href="https://github.com/DevExpress/testcafe">TestCafe</a> is not dependent on Selenium or WebDriver. Instead, it injects scripts into the browser to communicate directly with the DOM and handle events. It works on any modern browser that supports HTML5 without any plugins.</p>

<blockquote>
<p>Please review the <a href="http://devexpress.github.io/testcafe/documentation/getting-started/">Getting Started</a> guide before beginning.</p>
</blockquote>

<p>To install, first add a <em><a href="https://docs.npmjs.com/files/package.json">package.json</a></em> to the project root:</p>
<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;flask-microservices-main&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p>Then install the dependency:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>npm install testcafe --save
</code></pre></div>
<p>The <code>--save</code> flag adds the dependency info to the <em>package.json</em>:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="o">{</span>
  <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;flask-microservices-main&quot;</span>,
  <span class="s2">&quot;dependencies&quot;</span>: <span class="o">{</span>
    <span class="s2">&quot;testcafe&quot;</span>: <span class="s2">&quot;^0.16.1&quot;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>The dependency (and sub dependencies) were installed to a newly created &quot;node_modules&quot; directory. Add this directory to the <em>.gitignore</em> file.</p>

<p>Let&#39;s write our first test spec!</p>

<h4 id="first-test">First Test</h4>

<p>First, add a new folder to the project root called &quot;e2e&quot;. Then add a new file to that folder called <em>index.test.js</em>:</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Selector</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;testcafe&#39;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">TEST_URL</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">TEST_URL</span><span class="p">;</span>


<span class="nx">fixture</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">).</span><span class="nx">page</span><span class="p">(</span><span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">TEST_URL</span><span class="p">}</span><span class="o">/</span><span class="err">`</span><span class="p">);</span>

<span class="nx">test</span><span class="p">(</span><span class="err">`</span><span class="nx">users</span> <span class="nx">should</span> <span class="nx">be</span> <span class="nx">able</span> <span class="nx">to</span> <span class="nx">view</span> <span class="nx">the</span> <span class="s1">&#39;/&#39;</span> <span class="nx">page</span><span class="err">`</span><span class="p">,</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>

  <span class="nx">await</span> <span class="nx">t</span>
    <span class="p">.</span><span class="nx">navigateTo</span><span class="p">(</span><span class="nx">TEST_URL</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="nx">Selector</span><span class="p">(</span><span class="s1">&#39;H1&#39;</span><span class="p">).</span><span class="nx">withText</span><span class="p">(</span><span class="s1">&#39;All Users&#39;</span><span class="p">).</span><span class="nx">exists</span><span class="p">).</span><span class="nx">ok</span><span class="p">()</span>

<span class="p">});</span>
</code></pre></div>
<p>This test simply navigates to the main URL, <code>/</code>, and then assers that an <code>H1</code> element exists with the text <code>All Users</code>.</p>

<p>Set the environment variable:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span><span class="nb">export </span><span class="nv">TEST_URL</span><span class="o">=</span>DOCKER_MACHINE_DEV_IP
</code></pre></div>
<p>Run the tests:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>testcafe chrome e2e
</code></pre></div>
<p>You should see a new Chrome window open, which navigates to the main page and then TestCafe runs the assertion.</p>

<p>In the terminal, you should see something like:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span>testcafe chrome e2e
Using locally installed version of TestCafe.
 Running tests in:
 - Chrome 58.0.3029 / Mac OS X 10.11.6

 /
 users should be able to view the <span class="s1">&#39;/&#39;</span> page


 <span class="m">1</span> passed <span class="o">(</span>1s<span class="o">)</span>
</code></pre></div>
<p>Experiment with this. Try <a href="http://devexpress.github.io/testcafe/documentation/test-api/actions/navigate.html">navigating</a> to a different page. Add a <a href="http://devexpress.github.io/testcafe/documentation/test-api/actions/click.html">click action</a>. Set up additional <a href="http://devexpress.github.io/testcafe/documentation/test-api/selecting-page-elements/selectors.html">selectors</a> and run some more assertions.</p>

<h4 id="ci">CI</h4>

<p>Add the test to the <em>test.sh</em> file:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c">#!/bin/bash</span>

<span class="nv">fails</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

inspect<span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">[</span> <span class="nv">$1</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">fails</span><span class="o">=</span><span class="s2">&quot;${fails} $2&quot;</span>
  <span class="k">fi</span>
<span class="o">}</span>

docker-compose run users-service python manage.py <span class="nb">test</span>
inspect <span class="nv">$?</span> users-service

testcafe chrome e2e
inspect <span class="nv">$?</span> e2e

<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;${fails}&quot;</span> <span class="o">]</span><span class="p">;</span>
  <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;Tests failed: ${fails}&quot;</span>
    <span class="nb">exit </span>1
  <span class="k">else</span>
    <span class="nb">echo</span> <span class="s2">&quot;Tests passed!&quot;</span>
    <span class="nb">exit </span>0
<span class="k">fi</span>
</code></pre></div>
<p>Make sure the tests pass again, and then update <em>.travis.yml</em> like so:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">language</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">node_js</span>
<span class="l-Scalar-Plain">node_js</span><span class="p-Indicator">:</span> <span class="s">&#39;7&#39;</span>

<span class="l-Scalar-Plain">before_install</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">stty cols 80</span>

<span class="l-Scalar-Plain">dist</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">trusty</span>
<span class="l-Scalar-Plain">sudo</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">required</span>

<span class="l-Scalar-Plain">addons</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">apt</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">sources</span><span class="p-Indicator">:</span>
     <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">google-chrome</span>
    <span class="l-Scalar-Plain">packages</span><span class="p-Indicator">:</span>
     <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">google-chrome-stable</span>

<span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">docker</span>

<span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">global</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">DOCKER_COMPOSE_VERSION=1.11.2</span>

<span class="l-Scalar-Plain">before_install</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">sudo rm /usr/local/bin/docker-compose</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` &gt; docker-compose</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">chmod +x docker-compose</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">sudo mv docker-compose /usr/local/bin</span>

<span class="l-Scalar-Plain">before_script</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">export TEST_URL=http://127.0.0.1</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">export REACT_APP_USERS_SERVICE_URL=http://127.0.0.1</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">export DISPLAY=:99.0</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">sh -e /etc/init.d/xvfb start</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">sleep 3</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">docker-compose up --build -d</span>

<span class="l-Scalar-Plain">script</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">docker-compose run users-service python manage.py test</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">testcafe chrome e2e/index.test.js</span>

<span class="l-Scalar-Plain">after_script</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">docker-compose down</span>
</code></pre></div>
<p>Here, we added the Node version along with some basic Chrome settings. Also, we have to use <a href="https://docs.travis-ci.com/user/gui-and-headless-browsers/#Using-xvfb-to-Run-Tests-That-Require-a-GUI">xvfb</a> to fake a GUI so that Chrome thinks it&#39;s running in a graphical environment.</p>

<blockquote>
<p>Review the <a href="http://devexpress.github.io/testcafe/documentation/recipes/running-tests-in-firefox-and-chrome-using-travis-ci.html">Running Tests in Firefox and Chrome Using Travis CI</a> for more info.</p>
</blockquote>

<p>Commit your code and push it up to GitHub. Make sure the tests pass on Travis.</p>


          
  <br><br>
  <a class="twitter-share-button" data-show-count="false" href="https://twitter.com/intent/tweet?text=Microservices with Docker, Flask, and React - End-to-End Test Setup&amp;url=http%3A%2F%2Ftestdriven.io/part-four-e2e-test-setup&amp;via=RealPython" rel="nofollow" target="_blank" title="Share on Twitter"></a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>



          <div class="page-nav">
            
              <a class="prev btn left-align" href="/part-four-intro">&laquo; Introduction</a>
            
            
              <a class="next btn right-align" href="/part-four-e2e-test-specs">End-to-End Test Specs &raquo;</a>
            
          </div>

        </div>

      </div>
    </div>

     <footer class="page-footer white">
  <div class="container footer-container center-align">
    <ul>
      <li>Content by Michael Herman (michael@realpython.com)</li>
      <li>&copy; Copyright 2017 <a href="http://realpython.com">Real Python</a></li>
    </ul>
  </div>
</footer>


    <script type="text/javascript" src="//code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/materialize/0.97.3/js/materialize.min.js"></script>

    
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-100160465-1', 'auto');
    ga('send', 'pageview');

  </script>



  </body>
</html>
