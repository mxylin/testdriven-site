<!DOCTYPE html>
<html>

  <head>
  
    <title>Microservices with Docker, Flask, and React - Flask Migrate</title>
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="shortcut icon" type="image/png" href="/favicon.ico">
  <link
    rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css"
  >
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/icon?family=Material+Icons"
  >
  <link
    rel="stylesheet"
    href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
  >
  <link
    href="//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic"
    rel="stylesheet"
    type="text/css"
  >
  <link
    href="//fonts.googleapis.com/css?family=Lato:900,300"
    rel="stylesheet"
    type="text/css"
  >
  <link
    href="https://fonts.googleapis.com/css?family=Montserrat"
    rel="stylesheet"
    type="text/css"
  >
  <link
    href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css"
    rel="stylesheet"
    type="text/css"
  >
  <link href="/assets/css/styles.css?1512157026107612000" rel="stylesheet">
  <script
    src="//code.jquery.com/jquery-2.2.4.min.js"
    integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
    crossorigin="anonymous"
  ></script>
  <script
    type="text/javascript"
    src="/assets/js/main.js"
  ></script>
  <script
    type="text/javascript"
    src="https://gumroad.com/js/gumroad.js"
  ></script>
</head>


  <body>

    <nav class="indigo darken-4">
  <div class="nav-wrapper">
    <a href="/" class="nav-logo-container left">
      <img
        class="nav-logo" src="/assets/img/test_driven_io_full_logo_white_text.svg" alt="testdriven.io"
      />
    </a>
    <a href="/" class="brand-logo main-brand-logo center show-on-large hide-on-med-and-down">
      Test Driven Development Courses
    </a>
    <!-- <a href="/" class="brand-logo main-brand-logo hide-on-large-only">
      TDD Courses
    </a> -->
    <a href="#" data-activates="mobile-demo" class="right button-collapse"><i class="material-icons">menu</i></a>
    <ul class="right hide-on-med-and-down">
      <li><a href="/course-contents">Contents</a></li>
      <li><a href="/version-two">Version 2</a></li>
    </ul>
    <ul class="side-nav" id="mobile-demo">
      <li><a href="/">Home</a></li>
      <li><a href="/course-contents">Contents</a></li>
      <li><a href="/version-two">Version 2</a></li>
    </ul>
  </div>
</nav>


    <br>

    <div class="container">
      <div class="row">

        <div class="col m3 hide-on-small-and-down">
  <br>
  <div id="toc-block" class="collection hide-on-small-and-down">
    <ul class="collapsible collapsible-accordion">
      
        
          <li>
            <h5 data-part="1" class="collapsible-header  waves-effect waves-teal">
              Part 1
            </h5>
            <div class="collapsible-body">
        
        <ul>
          <li class="collection-li">
            <span>1.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-one-intro"
              >Introduction</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>2.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-one-getting-started"
              >Getting Started</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>3.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-one-docker-config"
              >Docker Config</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>4.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-one-postgres-setup"
              >Postgres Setup</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>5.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-one-test-setup"
              >Test Setup</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>6.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-one-flask-blueprints"
              >Flask Blueprints</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>7.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-one-restful-routes"
              >RESTful Routes</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>8.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-one-aws-deployment"
              >Deployment</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>9.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-one-jinja-templates"
              >Jinja Templates</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>10.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-one-workflow"
              >Workflow</a>
            </span>
          </li>
        </ul>
      
        
          <li>
            <h5 data-part="2" class="collapsible-header  waves-effect waves-teal">
              Part 2
            </h5>
            <div class="collapsible-body">
        
        <ul>
          <li class="collection-li">
            <span>1.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-two-intro"
              >Introduction</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>2.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-two-project-refactor"
              >Project Refactor</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>3.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-two-code-coverage"
              >Code Coverage</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>4.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-two-continuous-integration"
              >Continuous Integration</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>5.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-two-react-setup"
              >React Setup</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>6.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-two-flask-deployment"
              >Flask Deployment</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>7.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-two-react-forms"
              >React Forms</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>8.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-two-react-docker"
              >React and Docker</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>9.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-two-flask-refactor"
              >Flask Refactor</a>
            </span>
          </li>
        </ul>
      
        
          <li>
            <h5 data-part="3" class="collapsible-header  waves-effect waves-teal">
              Part 3
            </h5>
            <div class="collapsible-body">
        
        <ul>
          <li class="collection-li">
            <span>1.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-three-intro"
              >Introduction</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>2.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-three-flask-migrate"
              >Flask Migrate</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>3.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-three-flask-bcrypt"
              >Flask Bcrypt</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>4.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-three-jwt-setup"
              >JWT Setup</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>5.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-three-auth-routes"
              >Auth Routes</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>6.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-three-react-router"
              >React Router</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>7.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-three-react-bootstrap"
              >React Bootstrap</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>8.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-three-react-authentication"
              >React Authentication</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>9.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-three-authorization"
              >Authorization</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>10.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-three-update-component"
              >Update Component</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>11.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-three-update-docker"
              >Update Docker</a>
            </span>
          </li>
        </ul>
      
        
          <li>
            <h5 data-part="4" class="collapsible-header  waves-effect waves-teal">
              Part 4
            </h5>
            <div class="collapsible-body">
        
        <ul>
          <li class="collection-li">
            <span>1.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-four-intro"
              >Introduction</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>2.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-four-e2e-test-setup"
              >End-to-End Test Setup</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>3.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-four-e2e-test-specs"
              >End-to-End Test Specs</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>4.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-four-react-component-refactor"
              >React Component Refactor</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>5.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-four-react-form-validation"
              >React Form Validation</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>6.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-four-react-flash-messages"
              >React Flash Messaging</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>7.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-four-swagger-setup"
              >Swagger Setup</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>8.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-four-staging-environment"
              >Staging Environment</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>9.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-four-workflow"
              >Workflow</a>
            </span>
          </li>
        </ul>
      
        
          <li>
            <h5 data-part="5" class="collapsible-header  waves-effect waves-teal">
              Part 5
            </h5>
            <div class="collapsible-body">
        
        <ul>
          <li class="collection-li">
            <span>1.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-five-intro"
              >Introduction</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>2.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-five-docker-hub"
              >Docker Hub</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>3.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-five-ec2-container-registry"
              >EC2 Container Registry</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>4.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-five-ec2-container-service"
              >EC2 Container Service</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>5.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-five-elastic-load-balancing"
              >Elastic Load Balancing</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>6.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-five-ec2-container-service-staging"
              >ECS Staging</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>7.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-five-ec2-relational-database-service"
              >Setting up RDS</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>8.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-five-ec2-container-service-production"
              >ECS Production</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>9.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-five-workflow"
              >Workflow</a>
            </span>
          </li>
        </ul>
      
        
          <li>
            <h5 data-part="6" class="collapsible-header  waves-effect waves-teal">
              Part 6
            </h5>
            <div class="collapsible-body">
        
        <ul>
          <li class="collection-li">
            <span>1.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-six-intro"
              >Introduction</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>2.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-six-eval-service-setup"
              >Eval Service Setup</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>3.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-six-scores-api-database"
              >Scores API Database</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>4.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-six-scores-api-routes"
              >Scores API Routes</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>5.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-six-exercises-api"
              >Exercises API</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>6.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-six-react-refactor"
              >React Refactor</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>7.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-six-e2e-tests-refactor"
              >End-to-End Tests Refactor</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>8.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-six-react-ace-code-editor"
              >React Ace Code Editor</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>9.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-six-code-evaluation"
              >Code Evaluation</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>10.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-six-ecs-deployment"
              >ECS Deployment</a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>11.&nbsp;</span>
            <span>
              <a
                class="collection-item"
                href="/part-six-next-steps"
              >Next Steps</a>
            </span>
          </li>
        </ul>
      
    </div>
  </li>
    </ul>
  </div>
</div>


        <div class="col m9 hide-on-small-and-down">

          <h2>Flask Migrate</h2>

          
            <h5>Part 3, Lesson 2</h5>

            <div class="page-nav">
              
                <a class="prev btn left-align" href="/part-three-intro">&laquo; Introduction</a>
              
              
                <a class="next btn right-align" href="/part-three-flask-bcrypt">Flask Bcrypt &raquo;</a>
              
            </div>

            
  <br>
  <a class="twitter-share-button" data-show-count="false" href="https://twitter.com/intent/tweet?text=Microservices with Docker, Flask, and React - Flask Migrate&amp;url=http%3A%2F%2Ftestdriven.io/part-three-flask-migrate&amp;via=RealPython" rel="nofollow" target="_blank" title="Share on Twitter"></a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>



            <br><br>

          


          <p>In this lesson, we&#39;ll utilize Flask Migrate to handle database migrations...</p>

<hr>

<p>Navigate to <em>flask-microservices-users</em>, activate the virtual environment, add the environment variables, and then run the tests to ensure they pass:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span><span class="nb">source </span>env/bin/activate
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span><span class="nb">export </span><span class="nv">APP_SETTINGS</span><span class="o">=</span>project.config.DevelopmentConfig
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span><span class="nb">export </span><span class="nv">DATABASE_URL</span><span class="o">=</span>postgres://postgres:postgres@localhost:5432/users_dev
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span><span class="nb">export </span><span class="nv">DATABASE_TEST_URL</span><span class="o">=</span>postgres://postgres:postgres@localhost:5432/users_test
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>python manage.py <span class="nb">test</span>
</code></pre></div>
<blockquote>
<p>You may need to change the username and password depending on your local Postgres config.</p>
</blockquote>

<p>Let&#39;s make a few changes to the schema in <em>flask-microservices-users/project/api/models.py</em>:</p>

<ol>
<li><code>username</code> must be unique</li>
<li><code>email</code> must be unique</li>
<li><code>active</code> should default to <code>True</code></li>
</ol>

<p>We&#39;ll also add a password field, which will be hashed before it&#39;s added to the database:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">password</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div>
<p>With that, let&#39;s start with some tests. Add a new file to &quot;flask-microservices-users/project/tests&quot; called <em>test_user_model.py</em>. This file will hold tests related to our database model:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># project/tests/test_user_model.py</span>


<span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">project.api.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">project.tests.base</span> <span class="kn">import</span> <span class="n">BaseTestCase</span>


<span class="k">class</span> <span class="nc">TestUserModel</span><span class="p">(</span><span class="n">BaseTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s">&#39;justatest&#39;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;justatest&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>
</code></pre></div>
<p>Run the tests. You should see a single failure - <code>AssertionError: False is not true</code> - since <code>user.active</code> is <code>False</code>.</p>

<h4 id="flask-migrate"><span style="font-family:'Montserrat', 'sans-serif';">Flask Migrate</span></h4>

<p>Since we need to make a schema change, add <a href="https://flask-migrate.readthedocs.io/en/latest/">Flask-Migrate</a>:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>pip install flask-migrate<span class="o">==</span>2.0.4
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>pip freeze &gt; requirements.txt
</code></pre></div>
<p>In <em>flask-microservices-users/project/__init__.py</em> add the import, create a new instance, and update <code>create_app()</code>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># project/__init__.py</span>


<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span> <span class="nn">flask_cors</span> <span class="kn">import</span> <span class="n">CORS</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
<span class="kn">from</span> <span class="nn">flask_migrate</span> <span class="kn">import</span> <span class="n">Migrate</span>


<span class="c"># instantiate the db</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">()</span>
<span class="c"># instantiate flask migrate</span>
<span class="n">migrate</span> <span class="o">=</span> <span class="n">Migrate</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">create_app</span><span class="p">():</span>

    <span class="c"># instantiate the app</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

    <span class="c"># enable CORS</span>
    <span class="n">CORS</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

    <span class="c"># set config</span>
    <span class="n">app_settings</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;APP_SETTINGS&#39;</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">app_settings</span><span class="p">)</span>

    <span class="c"># set up extensions</span>
    <span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">migrate</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>

    <span class="c"># register blueprints</span>
    <span class="kn">from</span> <span class="nn">project.api.views</span> <span class="kn">import</span> <span class="n">users_blueprint</span>
    <span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">users_blueprint</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">app</span>
</code></pre></div>
<p>Then, add a new manager command to <em>flask-microservices-users/manage.py</em>, just below <code>manager = Manager(app)</code>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">manager</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="s">&#39;db&#39;</span><span class="p">,</span> <span class="n">MigrateCommand</span><span class="p">)</span>
</code></pre></div>
<p>Add the import as well:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">flask_migrate</span> <span class="kn">import</span> <span class="n">MigrateCommand</span>
</code></pre></div>
<p>Generate the migrations folder, add the initial migration, and then apply it to the database:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>python manage.py db init
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>python manage.py db migrate
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>python manage.py db upgrade
</code></pre></div>
<blockquote>
<p>Review the <a href="https://flask-migrate.readthedocs.io/en/latest/">documentation</a> for more info.</p>
</blockquote>

<p>Now, we can make the changes to the schema:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&quot;users&quot;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">active</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">created_at</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">created_at</span> <span class="o">=</span> <span class="n">created_at</span>
</code></pre></div>
<p>Again, run:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>python manage.py db migrate
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>python manage.py db upgrade
</code></pre></div>
<blockquote>
<p>Keep in mind that if you have any duplicate usernames and/or emails already in your database, you will get an error when trying to apply the migration to the database. You can either update the data or drop the db and start over.</p>
</blockquote>

<p>Run the tests again. They should pass! Before moving on, let&#39;s add a few more tests to <em>flask-microservices-users/project/tests/test_user_model.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">test_add_user_duplicate_username</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s">&#39;justatest&#39;</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">duplicate_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s">&#39;justatest&#39;</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test2.com&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">duplicate_user</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_add_user_duplicate_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s">&#39;justatest&#39;</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">duplicate_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s">&#39;justanothertest&#39;</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">duplicate_user</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span>
</code></pre></div>
<p>Notice how we didn&#39;t invoke <code>db.session.commit</code> the second time, when adding a user. Instead, we passed it to <code>assertRaises()</code> and let it invoke it and assert the exception was raised.</p>

<p>Add the import:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="kn">import</span> <span class="n">IntegrityError</span>
</code></pre></div>
<p>Test again.</p>

<h4 id="refactor"><span style="font-family:'Montserrat', 'sans-serif';">Refactor</span></h4>

<p>Now is a good time to do some refactoring...</p>

<p>First, in <em>flask-microservices-users/project/tests/test_users.py</em>, rename <code>test_add_user_duplicate_user</code> to <code>test_add_user_duplicate_email</code>.</p>

<p>Also, did you notice that we added a new user a number of times in the <em>test_user_model.py</em> tests? Let&#39;s abstract out the <code>add_user</code> helper function from <em>test_users.py</em> to a utility file so we can use it in both test files.</p>

<p>Add a new file called <em>utils.py</em> to &quot;tests&quot;:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># project/tests/utils.py</span>


<span class="kn">import</span> <span class="nn">datetime</span>


<span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">project.api.models</span> <span class="kn">import</span> <span class="n">User</span>


<span class="k">def</span> <span class="nf">add_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span> <span class="n">created_at</span><span class="o">=</span><span class="n">created_at</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">user</span>
</code></pre></div>
<p>Then remove the helper from <em>test_users.py</em> and add the import to the same file:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">project.tests.utils</span> <span class="kn">import</span> <span class="n">add_user</span>
</code></pre></div>
<p>Refactor <em>test_user_model.py</em> like so:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># project/tests/test_user_model.py</span>


<span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="kn">import</span> <span class="n">IntegrityError</span>

<span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">project.api.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">project.tests.base</span> <span class="kn">import</span> <span class="n">BaseTestCase</span>
<span class="kn">from</span> <span class="nn">project.tests.utils</span> <span class="kn">import</span> <span class="n">add_user</span>

<span class="k">class</span> <span class="nc">TestUserModel</span><span class="p">(</span><span class="n">BaseTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">add_user</span><span class="p">(</span><span class="s">&#39;justatest&#39;</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;justatest&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_add_user_duplicate_username</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">add_user</span><span class="p">(</span><span class="s">&#39;justatest&#39;</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="n">duplicate_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s">&#39;justatest&#39;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test2.com&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">duplicate_user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_add_user_duplicate_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">add_user</span><span class="p">(</span><span class="s">&#39;justatest&#39;</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="n">duplicate_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s">&#39;justatest2&#39;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">duplicate_user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span>
</code></pre></div>
<p>Run the tests again to ensure nothing broke.</p>


          <div class="page-nav">
            
              <a class="prev btn left-align" href="/part-three-intro">&laquo; Introduction</a>
            
            
              <a class="next btn right-align" href="/part-three-flask-bcrypt">Flask Bcrypt &raquo;</a>
            
          </div>

          
  <br>
  <a class="twitter-share-button" data-show-count="false" href="https://twitter.com/intent/tweet?text=Microservices with Docker, Flask, and React - Flask Migrate&amp;url=http%3A%2F%2Ftestdriven.io/part-three-flask-migrate&amp;via=RealPython" rel="nofollow" target="_blank" title="Share on Twitter"></a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>



        </div>

        <div class="hide-on-med-and-up">

          <h2>Flask Migrate</h2>

          <p>In this lesson, we&#39;ll utilize Flask Migrate to handle database migrations...</p>

<hr>

<p>Navigate to <em>flask-microservices-users</em>, activate the virtual environment, add the environment variables, and then run the tests to ensure they pass:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span><span class="nb">source </span>env/bin/activate
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span><span class="nb">export </span><span class="nv">APP_SETTINGS</span><span class="o">=</span>project.config.DevelopmentConfig
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span><span class="nb">export </span><span class="nv">DATABASE_URL</span><span class="o">=</span>postgres://postgres:postgres@localhost:5432/users_dev
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span><span class="nb">export </span><span class="nv">DATABASE_TEST_URL</span><span class="o">=</span>postgres://postgres:postgres@localhost:5432/users_test
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>python manage.py <span class="nb">test</span>
</code></pre></div>
<blockquote>
<p>You may need to change the username and password depending on your local Postgres config.</p>
</blockquote>

<p>Let&#39;s make a few changes to the schema in <em>flask-microservices-users/project/api/models.py</em>:</p>

<ol>
<li><code>username</code> must be unique</li>
<li><code>email</code> must be unique</li>
<li><code>active</code> should default to <code>True</code></li>
</ol>

<p>We&#39;ll also add a password field, which will be hashed before it&#39;s added to the database:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">password</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div>
<p>With that, let&#39;s start with some tests. Add a new file to &quot;flask-microservices-users/project/tests&quot; called <em>test_user_model.py</em>. This file will hold tests related to our database model:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># project/tests/test_user_model.py</span>


<span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">project.api.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">project.tests.base</span> <span class="kn">import</span> <span class="n">BaseTestCase</span>


<span class="k">class</span> <span class="nc">TestUserModel</span><span class="p">(</span><span class="n">BaseTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s">&#39;justatest&#39;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;justatest&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>
</code></pre></div>
<p>Run the tests. You should see a single failure - <code>AssertionError: False is not true</code> - since <code>user.active</code> is <code>False</code>.</p>

<h4 id="flask-migrate"><span style="font-family:'Montserrat', 'sans-serif';">Flask Migrate</span></h4>

<p>Since we need to make a schema change, add <a href="https://flask-migrate.readthedocs.io/en/latest/">Flask-Migrate</a>:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>pip install flask-migrate<span class="o">==</span>2.0.4
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>pip freeze &gt; requirements.txt
</code></pre></div>
<p>In <em>flask-microservices-users/project/__init__.py</em> add the import, create a new instance, and update <code>create_app()</code>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># project/__init__.py</span>


<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span> <span class="nn">flask_cors</span> <span class="kn">import</span> <span class="n">CORS</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
<span class="kn">from</span> <span class="nn">flask_migrate</span> <span class="kn">import</span> <span class="n">Migrate</span>


<span class="c"># instantiate the db</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">()</span>
<span class="c"># instantiate flask migrate</span>
<span class="n">migrate</span> <span class="o">=</span> <span class="n">Migrate</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">create_app</span><span class="p">():</span>

    <span class="c"># instantiate the app</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

    <span class="c"># enable CORS</span>
    <span class="n">CORS</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

    <span class="c"># set config</span>
    <span class="n">app_settings</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;APP_SETTINGS&#39;</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">app_settings</span><span class="p">)</span>

    <span class="c"># set up extensions</span>
    <span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">migrate</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>

    <span class="c"># register blueprints</span>
    <span class="kn">from</span> <span class="nn">project.api.views</span> <span class="kn">import</span> <span class="n">users_blueprint</span>
    <span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">users_blueprint</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">app</span>
</code></pre></div>
<p>Then, add a new manager command to <em>flask-microservices-users/manage.py</em>, just below <code>manager = Manager(app)</code>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">manager</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="s">&#39;db&#39;</span><span class="p">,</span> <span class="n">MigrateCommand</span><span class="p">)</span>
</code></pre></div>
<p>Add the import as well:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">flask_migrate</span> <span class="kn">import</span> <span class="n">MigrateCommand</span>
</code></pre></div>
<p>Generate the migrations folder, add the initial migration, and then apply it to the database:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>python manage.py db init
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>python manage.py db migrate
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>python manage.py db upgrade
</code></pre></div>
<blockquote>
<p>Review the <a href="https://flask-migrate.readthedocs.io/en/latest/">documentation</a> for more info.</p>
</blockquote>

<p>Now, we can make the changes to the schema:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&quot;users&quot;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">active</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">created_at</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">created_at</span> <span class="o">=</span> <span class="n">created_at</span>
</code></pre></div>
<p>Again, run:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>python manage.py db migrate
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>python manage.py db upgrade
</code></pre></div>
<blockquote>
<p>Keep in mind that if you have any duplicate usernames and/or emails already in your database, you will get an error when trying to apply the migration to the database. You can either update the data or drop the db and start over.</p>
</blockquote>

<p>Run the tests again. They should pass! Before moving on, let&#39;s add a few more tests to <em>flask-microservices-users/project/tests/test_user_model.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">test_add_user_duplicate_username</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s">&#39;justatest&#39;</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">duplicate_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s">&#39;justatest&#39;</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test2.com&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">duplicate_user</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_add_user_duplicate_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s">&#39;justatest&#39;</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">duplicate_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s">&#39;justanothertest&#39;</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">duplicate_user</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span>
</code></pre></div>
<p>Notice how we didn&#39;t invoke <code>db.session.commit</code> the second time, when adding a user. Instead, we passed it to <code>assertRaises()</code> and let it invoke it and assert the exception was raised.</p>

<p>Add the import:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="kn">import</span> <span class="n">IntegrityError</span>
</code></pre></div>
<p>Test again.</p>

<h4 id="refactor"><span style="font-family:'Montserrat', 'sans-serif';">Refactor</span></h4>

<p>Now is a good time to do some refactoring...</p>

<p>First, in <em>flask-microservices-users/project/tests/test_users.py</em>, rename <code>test_add_user_duplicate_user</code> to <code>test_add_user_duplicate_email</code>.</p>

<p>Also, did you notice that we added a new user a number of times in the <em>test_user_model.py</em> tests? Let&#39;s abstract out the <code>add_user</code> helper function from <em>test_users.py</em> to a utility file so we can use it in both test files.</p>

<p>Add a new file called <em>utils.py</em> to &quot;tests&quot;:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># project/tests/utils.py</span>


<span class="kn">import</span> <span class="nn">datetime</span>


<span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">project.api.models</span> <span class="kn">import</span> <span class="n">User</span>


<span class="k">def</span> <span class="nf">add_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span> <span class="n">created_at</span><span class="o">=</span><span class="n">created_at</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">user</span>
</code></pre></div>
<p>Then remove the helper from <em>test_users.py</em> and add the import to the same file:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">project.tests.utils</span> <span class="kn">import</span> <span class="n">add_user</span>
</code></pre></div>
<p>Refactor <em>test_user_model.py</em> like so:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># project/tests/test_user_model.py</span>


<span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="kn">import</span> <span class="n">IntegrityError</span>

<span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">project.api.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">project.tests.base</span> <span class="kn">import</span> <span class="n">BaseTestCase</span>
<span class="kn">from</span> <span class="nn">project.tests.utils</span> <span class="kn">import</span> <span class="n">add_user</span>

<span class="k">class</span> <span class="nc">TestUserModel</span><span class="p">(</span><span class="n">BaseTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">add_user</span><span class="p">(</span><span class="s">&#39;justatest&#39;</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;justatest&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_add_user_duplicate_username</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">add_user</span><span class="p">(</span><span class="s">&#39;justatest&#39;</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="n">duplicate_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s">&#39;justatest&#39;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test2.com&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">duplicate_user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_add_user_duplicate_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">add_user</span><span class="p">(</span><span class="s">&#39;justatest&#39;</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="n">duplicate_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s">&#39;justatest2&#39;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">duplicate_user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span>
</code></pre></div>
<p>Run the tests again to ensure nothing broke.</p>


          
  <br>
  <a class="twitter-share-button" data-show-count="false" href="https://twitter.com/intent/tweet?text=Microservices with Docker, Flask, and React - Flask Migrate&amp;url=http%3A%2F%2Ftestdriven.io/part-three-flask-migrate&amp;via=RealPython" rel="nofollow" target="_blank" title="Share on Twitter"></a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>



          <div class="page-nav">
            
              <a class="prev btn left-align" href="/part-three-intro">&laquo; Introduction</a>
            
            
              <a class="next btn right-align" href="/part-three-flask-bcrypt">Flask Bcrypt &raquo;</a>
            
          </div>

        </div>

      </div>
    </div>

     <footer class="page-footer white">
  <div class="container footer-container center-align">
    <ul>
      <li><small>Content by Michael Herman (michael@mherman.org)</small></li>
      <li><small>&copy; Copyright 2017 <a href="http://testdriven.io">TestDriven.io</a></small></li>
    </ul>
  </div>
</footer>


    <script type="text/javascript" src="//code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>

    
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-100160465-1', 'auto');
    ga('send', 'pageview');

  </script>



  </body>
</html>
