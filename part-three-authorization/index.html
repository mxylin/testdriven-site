<!DOCTYPE html>
<html>

  <head>
  
    <title>Microservices with Docker, Flask, and React - Authorization</title>
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link
    rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/materialize/0.97.3/css/materialize.min.css"
  >
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/icon?family=Material+Icons"
  >
  <link
    rel="stylesheet"
    href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
  >
  <link
    href="//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic"
    rel="stylesheet"
    type="text/css"
  >
  <link
    href="//fonts.googleapis.com/css?family=Lato:900,300"
    rel="stylesheet"
    type="text/css"
  >
  <link
    href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css"
    rel="stylesheet"
    type="text/css"
  >
  <link href="/assets/css/styles.css" rel="stylesheet">
  <script
    src="//code.jquery.com/jquery-2.2.4.min.js"
    integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
    crossorigin="anonymous"
  ></script>
  <script
    type="text/javascript"
    src="/assets/js/main.js"
  ></script>
</head>


  <body>

    <nav class="red darken-1">
  <div class="nav-wrapper">
    <a href="/" class="brand-logo center hide-on-small-and-down">
      Test Driven Development Courses
    </a>
    <a href="/" class="brand-logo hide-on-med-and-up">
      TDD Courses
    </a>
    <ul class="right">
      <li class="hide-on-med-and-down">
        <a  href="/course-contents">Contents</a>
      </li>
      <li class="hide-on-large-only">
        <a href="/course-contents">TOC</a>
      </li>
    </ul>
  </div>
</nav>


    <br>

    <div class="container">
      <div class="row">

        <div class="col m3 hide-on-small-and-down">
  <br>
  <div id="toc-block" class="collection hide-on-small-and-down">
    <ul class="collapsible collapsible-accordion">
      
        
          <li>
            <h5 data-part="1" class="collapsible-header  waves-effect waves-teal">
              Part 1
            </h5>
            <div class="collapsible-body">
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-one-intro"
            >Introduction</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-one-getting-started"
            >Getting Started</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-one-docker-config"
            >Docker Config</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-one-postgres-setup"
            >Postgres Setup</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-one-test-setup"
            >Test Setup</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-one-flask-blueprints"
            >Flask Blueprints</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-one-restful-routes"
            >RESTful Routes</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-one-aws-deployment"
            >Deployment</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-one-jinja-templates"
            >Jinja Templates</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-one-workflow"
            >Workflow</a>
          </li>
        </ul>
      
        
          <li>
            <h5 data-part="2" class="collapsible-header  waves-effect waves-teal">
              Part 2
            </h5>
            <div class="collapsible-body">
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-two-intro"
            >Introduction</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-two-project-refactor"
            >Project Refactor</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-two-code-coverage"
            >Code Coverage</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-two-continuous-integration"
            >Continuous Integration</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-two-react-setup"
            >React Setup</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-two-flask-deployment"
            >Flask Deployment</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-two-react-forms"
            >React Forms</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-two-react-docker"
            >React and Docker</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-two-flask-refactor"
            >Flask Refactor</a>
          </li>
        </ul>
      
        
          <li>
            <h5 data-part="3" class="collapsible-header  waves-effect waves-teal">
              Part 3
            </h5>
            <div class="collapsible-body">
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-three-intro"
            >Introduction</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-three-flask-migrate"
            >Flask Migrate</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-three-flask-bcrypt"
            >Flask Bcrypt</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-three-jwt-setup"
            >JWT Setup</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-three-auth-routes"
            >Auth Routes</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-three-react-router"
            >React Router</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-three-react-bootstrap"
            >React Bootstrap</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-three-react-authentication"
            >React Authentication</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-three-authorization"
            >Authorization</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-three-update-component"
            >Update Component</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-three-update-docker"
            >Update Docker</a>
          </li>
        </ul>
      
        
          <li>
            <h5 data-part="4" class="collapsible-header  waves-effect waves-teal">
              Part 4
            </h5>
            <div class="collapsible-body">
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-four-intro"
            >Introduction</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-four-e2e-test-setup"
            >End-to-End Test Setup</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-four-e2e-test-specs"
            >End-to-End Test Specs</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-four-react-component-refactor"
            >React Component Refactor</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-four-react-form-validation"
            >React Form Validation</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-four-react-flash-messages"
            >React Flash Messaging</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-four-swagger-setup"
            >Swagger Setup</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-four-staging-environment"
            >Staging Environment</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-four-workflow"
            >Workflow</a>
          </li>
        </ul>
      
        
          <li>
            <h5 data-part="5" class="collapsible-header  waves-effect waves-teal">
              Part 5
            </h5>
            <div class="collapsible-body">
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-five-intro"
            >Introduction</a>
          </li>
        </ul>
      
    </div>
  </li>
    </ul>
  </div>
</div>


        <div class="col m9 hide-on-small-and-down">

          <h2>Authorization</h2>

          <p>With authentication done we can now turn our attention to authorization...</p>

<hr>

<p>First, some definitions:</p>

<ol>
<li><em>Authentication</em> - verifying (via user credentials) that the user is who they say they are</li>
<li><em>Authorization</em> - ensuring (via permissions) that a user is allowed to do something</li>
</ol>

<blockquote>
<p>Review <a href="https://en.wikipedia.org/wiki/Authentication#Authorization">Authentication vs. Authorization on Wikipedia</a> for more info.</p>
</blockquote>

<p>Navigate to <em>flask-microservices-users</em>, activate the virtual environment, add the environment variables, and then run the tests to ensure they pass:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span><span class="nb">source </span>env/bin/activate
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span><span class="nb">export </span><span class="nv">APP_SETTINGS</span><span class="o">=</span>project.config.DevelopmentConfig
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span><span class="nb">export </span><span class="nv">DATABASE_URL</span><span class="o">=</span>postgres://postgres:postgres@localhost:5432/users_dev
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span><span class="nb">export </span><span class="nv">DATABASE_TEST_URL</span><span class="o">=</span>postgres://postgres:postgres@localhost:5432/users_test
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span><span class="nb">export </span><span class="nv">SECRET_KEY</span><span class="o">=</span>my_precious
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>python manage.py <span class="nb">test</span>
</code></pre></div>
<blockquote>
<p>You may need to change the username and password depending on your local Postgres config.</p>
</blockquote>

<p>Routes:</p>

<table><thead>
<tr>
<th>Endpoint</th>
<th>HTTP Method</th>
<th>Authenticated?</th>
<th>Active?</th>
<th>Admin?</th>
</tr>
</thead><tbody>
<tr>
<td>/auth/register</td>
<td>POST</td>
<td>No</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td>/auth/login</td>
<td>POST</td>
<td>No</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td>/auth/logout</td>
<td>GET</td>
<td>Yes</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td>/auth/status</td>
<td>GET</td>
<td>Yes</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td>/users</td>
<td>GET</td>
<td>No</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td>/users/:id</td>
<td>GET</td>
<td>No</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td>/users</td>
<td>POST</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
</tr>
</tbody></table>

<p>So, for routes that you must be authenticated to view, you must be active. You also must be an admin to POST to the <code>/users</code> endpoint.</p>

<h4 id="active">Active</h4>

<p>Start with a test. Add the following to <em>flask-microservices-users/project/tests/test_auth.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">test_invalid_logout_inactive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">add_user</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">,</span> <span class="s">&#39;test&#39;</span><span class="p">)</span>
    <span class="c"># update user</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">user</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
        <span class="n">resp_login</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s">&#39;/auth/login&#39;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
                <span class="n">password</span><span class="o">=</span><span class="s">&#39;test&#39;</span>
            <span class="p">)),</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span>
        <span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s">&#39;/auth/logout&#39;</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">Authorization</span><span class="o">=</span><span class="s">&#39;Bearer &#39;</span> <span class="o">+</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
                    <span class="n">resp_login</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="p">)[</span><span class="s">&#39;auth_token&#39;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;error&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;Something went wrong. Please contact us.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">401</span><span class="p">)</span>
</code></pre></div>
<p>Ensure the tests fail, and then update <code>logout_user()</code> in <em>project/api/auth.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="nd">@auth_blueprint.route</span><span class="p">(</span><span class="s">&#39;/auth/logout&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">logout_user</span><span class="p">():</span>
    <span class="c"># get auth token</span>
    <span class="n">auth_header</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Authorization&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">auth_header</span><span class="p">:</span>
        <span class="n">auth_token</span> <span class="o">=</span> <span class="n">auth_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">decode_auth_token</span><span class="p">(</span><span class="n">auth_token</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">resp</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
                <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;error&#39;</span><span class="p">,</span>
                    <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;Something went wrong. Please contact us.&#39;</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">),</span> <span class="mi">401</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;success&#39;</span><span class="p">,</span>
                    <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;Successfully logged out.&#39;</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;error&#39;</span><span class="p">,</span>
                <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="n">resp</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">),</span> <span class="mi">401</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;error&#39;</span><span class="p">,</span>
            <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;Provide a valid auth token.&#39;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">),</span> <span class="mi">403</span>
</code></pre></div>
<p>Before moving on, let&#39;s do a quick refactor to keep our code DRY. We can move the auth logic out of the route handler and into a decorator.</p>

<p>Create a new file in &quot;project/api&quot; called <em>utils.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># project/api/utils.py</span>


<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>

<span class="kn">from</span> <span class="nn">project.api.models</span> <span class="kn">import</span> <span class="n">User</span>


<span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">decorated_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;error&#39;</span><span class="p">,</span>
            <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;Something went wrong. Please contact us.&#39;</span>
        <span class="p">}</span>
        <span class="n">code</span> <span class="o">=</span> <span class="mi">401</span>
        <span class="n">auth_header</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Authorization&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">auth_header</span><span class="p">:</span>
            <span class="n">response_object</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Provide a valid auth token.&#39;</span>
            <span class="n">code</span> <span class="o">=</span> <span class="mi">403</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">),</span> <span class="n">code</span>
        <span class="n">auth_token</span> <span class="o">=</span> <span class="n">auth_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">decode_auth_token</span><span class="p">(</span><span class="n">auth_token</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">response_object</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">),</span> <span class="n">code</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">resp</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">),</span> <span class="n">code</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">decorated_function</span>
</code></pre></div>
<p>Here, we abstracted out all the logic for ensuring a token is present and valid and that the associated user is active.</p>

<p>Import the decorator into <em>project/api/auth.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">project.api.utils</span> <span class="kn">import</span> <span class="n">authenticate</span>
</code></pre></div>
<p>Update the view:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="nd">@auth_blueprint.route</span><span class="p">(</span><span class="s">&#39;/auth/logout&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@authenticate</span>
<span class="k">def</span> <span class="nf">logout_user</span><span class="p">(</span><span class="n">resp</span><span class="p">):</span>
    <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;success&#39;</span><span class="p">,</span>
        <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;Successfully logged out.&#39;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">),</span> <span class="mi">200</span>
</code></pre></div>
<p>The code is DRY and now we can test the auth logic separate from the view in a unit test! Win-win. Let&#39;s do the same thing for the <code>/auth/status</code> endpoint.</p>

<p>Add the test:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">test_invalid_status_inactive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">add_user</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">,</span> <span class="s">&#39;test&#39;</span><span class="p">)</span>
    <span class="c"># update user</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">user</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
        <span class="n">resp_login</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s">&#39;/auth/login&#39;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
                <span class="n">password</span><span class="o">=</span><span class="s">&#39;test&#39;</span>
            <span class="p">)),</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span>
        <span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s">&#39;/auth/status&#39;</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">Authorization</span><span class="o">=</span><span class="s">&#39;Bearer &#39;</span> <span class="o">+</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
                    <span class="n">resp_login</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="p">)[</span><span class="s">&#39;auth_token&#39;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;error&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;Something went wrong. Please contact us.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">401</span><span class="p">)</span>
</code></pre></div>
<p>Now, update <code>get_user_status()</code>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="nd">@auth_blueprint.route</span><span class="p">(</span><span class="s">&#39;/auth/status&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@authenticate</span>
<span class="k">def</span> <span class="nf">get_user_status</span><span class="p">(</span><span class="n">resp</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">resp</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;success&#39;</span><span class="p">,</span>
        <span class="s">&#39;data&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
            <span class="s">&#39;email&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
            <span class="s">&#39;active&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">active</span><span class="p">,</span>
            <span class="s">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">created_at</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">),</span> <span class="mi">200</span>
</code></pre></div>
<p>Make sure the tests pass.</p>

<p>Moving on, for the <code>/users</code> POST endpoint, add a new test:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">test_add_user_inactive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">add_user</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">,</span> <span class="s">&#39;test&#39;</span><span class="p">)</span>
    <span class="c"># update user</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">user</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
        <span class="n">resp_login</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s">&#39;/auth/login&#39;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
                <span class="n">password</span><span class="o">=</span><span class="s">&#39;test&#39;</span>
            <span class="p">)),</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span>
        <span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s">&#39;/users&#39;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">username</span><span class="o">=</span><span class="s">&#39;michael&#39;</span><span class="p">,</span>
                <span class="n">email</span><span class="o">=</span><span class="s">&#39;michael@realpython.com&#39;</span><span class="p">,</span>
                <span class="n">password</span><span class="o">=</span><span class="s">&#39;test&#39;</span>
            <span class="p">)),</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">Authorization</span><span class="o">=</span><span class="s">&#39;Bearer &#39;</span> <span class="o">+</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
                    <span class="n">resp_login</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="p">)[</span><span class="s">&#39;auth_token&#39;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;error&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;Something went wrong. Please contact us.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">401</span><span class="p">)</span>
</code></pre></div>
<p>Make sure it fails, and then add the decorator to <code>add_user()</code> in <em>project/api/users.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="nd">@users_blueprint.route</span><span class="p">(</span><span class="s">&#39;/users&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@authenticate</span>
<span class="k">def</span> <span class="nf">add_user</span><span class="p">(</span><span class="n">resp</span><span class="p">):</span>
    <span class="o">...</span>
</code></pre></div>
<p>Run the tests. You should see a number of failures since we are not passing a valid token within the requests in the remaining tests for that endpoint. To fix, in each of the failing tests, you need to-</p>

<ol>
<li><p>add a user</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">add_user</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">,</span> <span class="s">&#39;test&#39;</span><span class="p">)</span>
</code></pre></div></li>
<li><p>log the user in</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">resp_login</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
    <span class="s">&#39;/auth/login&#39;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="s">&#39;test&#39;</span>
    <span class="p">)),</span>
    <span class="n">content_type</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span>
<span class="p">)</span>
</code></pre></div></li>
<li><p>add the token to the requests</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
    <span class="s">&#39;/users&#39;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s">&#39;michael&#39;</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="s">&#39;michael@realpython.com&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="s">&#39;test&#39;</span>
    <span class="p">)),</span>
    <span class="n">content_type</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">,</span>
    <span class="n">headers</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">Authorization</span><span class="o">=</span><span class="s">&#39;Bearer &#39;</span> <span class="o">+</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
            <span class="n">resp_login</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="p">)[</span><span class="s">&#39;auth_token&#39;</span><span class="p">]</span>
    <span class="p">)</span>
<span class="p">)</span>
</code></pre></div></li>
</ol>

<p>Refactor. Test again to make sure they pass.</p>

<h4 id="admin">Admin</h4>

<p>Finally, in order to POST to the <code>/users</code> endpoint, you must be an admin. Turn to the models. Do we have an admin property? No. Let&#39;s add one. Start by adding an additional assert to the <code>test_add_user</code> test in <em>project/tests/test_user_model.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">test_add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">add_user</span><span class="p">(</span><span class="s">&#39;justatest&#39;</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">,</span> <span class="s">&#39;test&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;justatest&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">admin</span> <span class="o">==</span> <span class="bp">False</span><span class="p">)</span>
</code></pre></div>
<p>After the tests fail, add the property to the model:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">admin</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div>
<p>Create the migration:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="o">(</span>env<span class="o">)</span> <span class="nv">$ </span>python manage.py db migrate
</code></pre></div>
<p>Drop the <code>users_dev</code> database, and then re-create it. Apply the migrations:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="o">(</span>env<span class="o">)</span> <span class="nv">$ </span>python manage.py db upgrade
</code></pre></div>
<blockquote>
<p>We had to drop the database since the existing users did not have the admin property. Since it was required, we could not apply the migration. If you wanted to maintain the existing users, you could set <code>nullable</code> as <code>True</code>. Apply the migration, update the existing users, and then create a new migration to set <code>nullable</code> as <code>False</code>.</p>
</blockquote>

<p>The tests should pass. Next, let&#39;s add a new test to <em>project/tests/test_users.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">test_add_user_not_admin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">add_user</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">,</span> <span class="s">&#39;test&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
        <span class="c"># user login</span>
        <span class="n">resp_login</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s">&#39;/auth/login&#39;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
                <span class="n">password</span><span class="o">=</span><span class="s">&#39;test&#39;</span>
            <span class="p">)),</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span>
        <span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s">&#39;/users&#39;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">username</span><span class="o">=</span><span class="s">&#39;michael&#39;</span><span class="p">,</span>
                <span class="n">email</span><span class="o">=</span><span class="s">&#39;michael@realpython.com&#39;</span><span class="p">,</span>
                <span class="n">password</span><span class="o">=</span><span class="s">&#39;test&#39;</span>
            <span class="p">)),</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">Authorization</span><span class="o">=</span><span class="s">&#39;Bearer &#39;</span> <span class="o">+</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
                    <span class="n">resp_login</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="p">)[</span><span class="s">&#39;auth_token&#39;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;error&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;You do not have permission to do that.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">401</span><span class="p">)</span>
</code></pre></div>
<p>Add a helper to <em>project/api/utils.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">admin</span>
</code></pre></div>
<p>Import it in to <em>project/api/users.py</em>, and then add the check to the top of the function:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="nd">@users_blueprint.route</span><span class="p">(</span><span class="s">&#39;/users&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@authenticate</span>
<span class="k">def</span> <span class="nf">add_user</span><span class="p">(</span><span class="n">resp</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_admin</span><span class="p">(</span><span class="n">resp</span><span class="p">):</span>
        <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;error&#39;</span><span class="p">,</span>
            <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;You do not have permission to do that.&#39;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">),</span> <span class="mi">401</span>
</code></pre></div>
<p>Run the tests. There will be a number of failures. Add the following to the top of the failing tests, right after <code>add_user(&#39;test&#39;, &#39;test@test.com&#39;, &#39;test&#39;)</code>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># update user</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="n">user</span><span class="o">.</span><span class="n">admin</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div>
<p>Test it again. Once they pass, commit your code and move on.</p>

<blockquote>
<p>It&#39;s probably a good time to refactor some of the tests to keep them DRY. Do this on your own.</p>
</blockquote>


          
  <br><br>
  <a class="twitter-share-button" data-show-count="false" href="https://twitter.com/intent/tweet?text=Microservices with Docker, Flask, and React - Authorization&amp;url=http%3A%2F%2Ftestdriven.io/part-three-authorization&amp;via=RealPython" rel="nofollow" target="_blank" title="Share on Twitter"></a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>



          <div class="page-nav">
            
              <a class="prev btn left-align" href="/part-three-react-authentication">&laquo; React Authentication</a>
            
            
              <a class="next btn right-align" href="/part-three-update-component">Update Component &raquo;</a>
            
          </div>

        </div>

        <div class="hide-on-med-and-up">

          <h2>Authorization</h2>

          <p>With authentication done we can now turn our attention to authorization...</p>

<hr>

<p>First, some definitions:</p>

<ol>
<li><em>Authentication</em> - verifying (via user credentials) that the user is who they say they are</li>
<li><em>Authorization</em> - ensuring (via permissions) that a user is allowed to do something</li>
</ol>

<blockquote>
<p>Review <a href="https://en.wikipedia.org/wiki/Authentication#Authorization">Authentication vs. Authorization on Wikipedia</a> for more info.</p>
</blockquote>

<p>Navigate to <em>flask-microservices-users</em>, activate the virtual environment, add the environment variables, and then run the tests to ensure they pass:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span><span class="nb">source </span>env/bin/activate
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span><span class="nb">export </span><span class="nv">APP_SETTINGS</span><span class="o">=</span>project.config.DevelopmentConfig
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span><span class="nb">export </span><span class="nv">DATABASE_URL</span><span class="o">=</span>postgres://postgres:postgres@localhost:5432/users_dev
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span><span class="nb">export </span><span class="nv">DATABASE_TEST_URL</span><span class="o">=</span>postgres://postgres:postgres@localhost:5432/users_test
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span><span class="nb">export </span><span class="nv">SECRET_KEY</span><span class="o">=</span>my_precious
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>python manage.py <span class="nb">test</span>
</code></pre></div>
<blockquote>
<p>You may need to change the username and password depending on your local Postgres config.</p>
</blockquote>

<p>Routes:</p>

<table><thead>
<tr>
<th>Endpoint</th>
<th>HTTP Method</th>
<th>Authenticated?</th>
<th>Active?</th>
<th>Admin?</th>
</tr>
</thead><tbody>
<tr>
<td>/auth/register</td>
<td>POST</td>
<td>No</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td>/auth/login</td>
<td>POST</td>
<td>No</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td>/auth/logout</td>
<td>GET</td>
<td>Yes</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td>/auth/status</td>
<td>GET</td>
<td>Yes</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td>/users</td>
<td>GET</td>
<td>No</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td>/users/:id</td>
<td>GET</td>
<td>No</td>
<td>N/A</td>
<td>N/A</td>
</tr>
<tr>
<td>/users</td>
<td>POST</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
</tr>
</tbody></table>

<p>So, for routes that you must be authenticated to view, you must be active. You also must be an admin to POST to the <code>/users</code> endpoint.</p>

<h4 id="active">Active</h4>

<p>Start with a test. Add the following to <em>flask-microservices-users/project/tests/test_auth.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">test_invalid_logout_inactive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">add_user</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">,</span> <span class="s">&#39;test&#39;</span><span class="p">)</span>
    <span class="c"># update user</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">user</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
        <span class="n">resp_login</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s">&#39;/auth/login&#39;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
                <span class="n">password</span><span class="o">=</span><span class="s">&#39;test&#39;</span>
            <span class="p">)),</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span>
        <span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s">&#39;/auth/logout&#39;</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">Authorization</span><span class="o">=</span><span class="s">&#39;Bearer &#39;</span> <span class="o">+</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
                    <span class="n">resp_login</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="p">)[</span><span class="s">&#39;auth_token&#39;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;error&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;Something went wrong. Please contact us.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">401</span><span class="p">)</span>
</code></pre></div>
<p>Ensure the tests fail, and then update <code>logout_user()</code> in <em>project/api/auth.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="nd">@auth_blueprint.route</span><span class="p">(</span><span class="s">&#39;/auth/logout&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">logout_user</span><span class="p">():</span>
    <span class="c"># get auth token</span>
    <span class="n">auth_header</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Authorization&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">auth_header</span><span class="p">:</span>
        <span class="n">auth_token</span> <span class="o">=</span> <span class="n">auth_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">decode_auth_token</span><span class="p">(</span><span class="n">auth_token</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">resp</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
                <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;error&#39;</span><span class="p">,</span>
                    <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;Something went wrong. Please contact us.&#39;</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">),</span> <span class="mi">401</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;success&#39;</span><span class="p">,</span>
                    <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;Successfully logged out.&#39;</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;error&#39;</span><span class="p">,</span>
                <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="n">resp</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">),</span> <span class="mi">401</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;error&#39;</span><span class="p">,</span>
            <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;Provide a valid auth token.&#39;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">),</span> <span class="mi">403</span>
</code></pre></div>
<p>Before moving on, let&#39;s do a quick refactor to keep our code DRY. We can move the auth logic out of the route handler and into a decorator.</p>

<p>Create a new file in &quot;project/api&quot; called <em>utils.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># project/api/utils.py</span>


<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>

<span class="kn">from</span> <span class="nn">project.api.models</span> <span class="kn">import</span> <span class="n">User</span>


<span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">decorated_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;error&#39;</span><span class="p">,</span>
            <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;Something went wrong. Please contact us.&#39;</span>
        <span class="p">}</span>
        <span class="n">code</span> <span class="o">=</span> <span class="mi">401</span>
        <span class="n">auth_header</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Authorization&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">auth_header</span><span class="p">:</span>
            <span class="n">response_object</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Provide a valid auth token.&#39;</span>
            <span class="n">code</span> <span class="o">=</span> <span class="mi">403</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">),</span> <span class="n">code</span>
        <span class="n">auth_token</span> <span class="o">=</span> <span class="n">auth_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">decode_auth_token</span><span class="p">(</span><span class="n">auth_token</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">response_object</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">),</span> <span class="n">code</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">resp</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">),</span> <span class="n">code</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">decorated_function</span>
</code></pre></div>
<p>Here, we abstracted out all the logic for ensuring a token is present and valid and that the associated user is active.</p>

<p>Import the decorator into <em>project/api/auth.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">project.api.utils</span> <span class="kn">import</span> <span class="n">authenticate</span>
</code></pre></div>
<p>Update the view:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="nd">@auth_blueprint.route</span><span class="p">(</span><span class="s">&#39;/auth/logout&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@authenticate</span>
<span class="k">def</span> <span class="nf">logout_user</span><span class="p">(</span><span class="n">resp</span><span class="p">):</span>
    <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;success&#39;</span><span class="p">,</span>
        <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;Successfully logged out.&#39;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">),</span> <span class="mi">200</span>
</code></pre></div>
<p>The code is DRY and now we can test the auth logic separate from the view in a unit test! Win-win. Let&#39;s do the same thing for the <code>/auth/status</code> endpoint.</p>

<p>Add the test:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">test_invalid_status_inactive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">add_user</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">,</span> <span class="s">&#39;test&#39;</span><span class="p">)</span>
    <span class="c"># update user</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">user</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
        <span class="n">resp_login</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s">&#39;/auth/login&#39;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
                <span class="n">password</span><span class="o">=</span><span class="s">&#39;test&#39;</span>
            <span class="p">)),</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span>
        <span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s">&#39;/auth/status&#39;</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">Authorization</span><span class="o">=</span><span class="s">&#39;Bearer &#39;</span> <span class="o">+</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
                    <span class="n">resp_login</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="p">)[</span><span class="s">&#39;auth_token&#39;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;error&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;Something went wrong. Please contact us.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">401</span><span class="p">)</span>
</code></pre></div>
<p>Now, update <code>get_user_status()</code>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="nd">@auth_blueprint.route</span><span class="p">(</span><span class="s">&#39;/auth/status&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@authenticate</span>
<span class="k">def</span> <span class="nf">get_user_status</span><span class="p">(</span><span class="n">resp</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">resp</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;success&#39;</span><span class="p">,</span>
        <span class="s">&#39;data&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
            <span class="s">&#39;email&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
            <span class="s">&#39;active&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">active</span><span class="p">,</span>
            <span class="s">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">created_at</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">),</span> <span class="mi">200</span>
</code></pre></div>
<p>Make sure the tests pass.</p>

<p>Moving on, for the <code>/users</code> POST endpoint, add a new test:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">test_add_user_inactive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">add_user</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">,</span> <span class="s">&#39;test&#39;</span><span class="p">)</span>
    <span class="c"># update user</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">user</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
        <span class="n">resp_login</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s">&#39;/auth/login&#39;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
                <span class="n">password</span><span class="o">=</span><span class="s">&#39;test&#39;</span>
            <span class="p">)),</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span>
        <span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s">&#39;/users&#39;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">username</span><span class="o">=</span><span class="s">&#39;michael&#39;</span><span class="p">,</span>
                <span class="n">email</span><span class="o">=</span><span class="s">&#39;michael@realpython.com&#39;</span><span class="p">,</span>
                <span class="n">password</span><span class="o">=</span><span class="s">&#39;test&#39;</span>
            <span class="p">)),</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">Authorization</span><span class="o">=</span><span class="s">&#39;Bearer &#39;</span> <span class="o">+</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
                    <span class="n">resp_login</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="p">)[</span><span class="s">&#39;auth_token&#39;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;error&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;Something went wrong. Please contact us.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">401</span><span class="p">)</span>
</code></pre></div>
<p>Make sure it fails, and then add the decorator to <code>add_user()</code> in <em>project/api/users.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="nd">@users_blueprint.route</span><span class="p">(</span><span class="s">&#39;/users&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@authenticate</span>
<span class="k">def</span> <span class="nf">add_user</span><span class="p">(</span><span class="n">resp</span><span class="p">):</span>
    <span class="o">...</span>
</code></pre></div>
<p>Run the tests. You should see a number of failures since we are not passing a valid token within the requests in the remaining tests for that endpoint. To fix, in each of the failing tests, you need to-</p>

<ol>
<li><p>add a user</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">add_user</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">,</span> <span class="s">&#39;test&#39;</span><span class="p">)</span>
</code></pre></div></li>
<li><p>log the user in</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">resp_login</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
    <span class="s">&#39;/auth/login&#39;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="s">&#39;test&#39;</span>
    <span class="p">)),</span>
    <span class="n">content_type</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span>
<span class="p">)</span>
</code></pre></div></li>
<li><p>add the token to the requests</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
    <span class="s">&#39;/users&#39;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s">&#39;michael&#39;</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="s">&#39;michael@realpython.com&#39;</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="s">&#39;test&#39;</span>
    <span class="p">)),</span>
    <span class="n">content_type</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">,</span>
    <span class="n">headers</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">Authorization</span><span class="o">=</span><span class="s">&#39;Bearer &#39;</span> <span class="o">+</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
            <span class="n">resp_login</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="p">)[</span><span class="s">&#39;auth_token&#39;</span><span class="p">]</span>
    <span class="p">)</span>
<span class="p">)</span>
</code></pre></div></li>
</ol>

<p>Refactor. Test again to make sure they pass.</p>

<h4 id="admin">Admin</h4>

<p>Finally, in order to POST to the <code>/users</code> endpoint, you must be an admin. Turn to the models. Do we have an admin property? No. Let&#39;s add one. Start by adding an additional assert to the <code>test_add_user</code> test in <em>project/tests/test_user_model.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">test_add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">add_user</span><span class="p">(</span><span class="s">&#39;justatest&#39;</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">,</span> <span class="s">&#39;test&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;justatest&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">admin</span> <span class="o">==</span> <span class="bp">False</span><span class="p">)</span>
</code></pre></div>
<p>After the tests fail, add the property to the model:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">admin</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div>
<p>Create the migration:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="o">(</span>env<span class="o">)</span> <span class="nv">$ </span>python manage.py db migrate
</code></pre></div>
<p>Drop the <code>users_dev</code> database, and then re-create it. Apply the migrations:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="o">(</span>env<span class="o">)</span> <span class="nv">$ </span>python manage.py db upgrade
</code></pre></div>
<blockquote>
<p>We had to drop the database since the existing users did not have the admin property. Since it was required, we could not apply the migration. If you wanted to maintain the existing users, you could set <code>nullable</code> as <code>True</code>. Apply the migration, update the existing users, and then create a new migration to set <code>nullable</code> as <code>False</code>.</p>
</blockquote>

<p>The tests should pass. Next, let&#39;s add a new test to <em>project/tests/test_users.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">test_add_user_not_admin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">add_user</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">,</span> <span class="s">&#39;test&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
        <span class="c"># user login</span>
        <span class="n">resp_login</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s">&#39;/auth/login&#39;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
                <span class="n">password</span><span class="o">=</span><span class="s">&#39;test&#39;</span>
            <span class="p">)),</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span>
        <span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s">&#39;/users&#39;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">username</span><span class="o">=</span><span class="s">&#39;michael&#39;</span><span class="p">,</span>
                <span class="n">email</span><span class="o">=</span><span class="s">&#39;michael@realpython.com&#39;</span><span class="p">,</span>
                <span class="n">password</span><span class="o">=</span><span class="s">&#39;test&#39;</span>
            <span class="p">)),</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">Authorization</span><span class="o">=</span><span class="s">&#39;Bearer &#39;</span> <span class="o">+</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
                    <span class="n">resp_login</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="p">)[</span><span class="s">&#39;auth_token&#39;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;error&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;You do not have permission to do that.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">401</span><span class="p">)</span>
</code></pre></div>
<p>Add a helper to <em>project/api/utils.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">is_admin</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">admin</span>
</code></pre></div>
<p>Import it in to <em>project/api/users.py</em>, and then add the check to the top of the function:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="nd">@users_blueprint.route</span><span class="p">(</span><span class="s">&#39;/users&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@authenticate</span>
<span class="k">def</span> <span class="nf">add_user</span><span class="p">(</span><span class="n">resp</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_admin</span><span class="p">(</span><span class="n">resp</span><span class="p">):</span>
        <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;error&#39;</span><span class="p">,</span>
            <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;You do not have permission to do that.&#39;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">),</span> <span class="mi">401</span>
</code></pre></div>
<p>Run the tests. There will be a number of failures. Add the following to the top of the failing tests, right after <code>add_user(&#39;test&#39;, &#39;test@test.com&#39;, &#39;test&#39;)</code>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># update user</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="n">user</span><span class="o">.</span><span class="n">admin</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div>
<p>Test it again. Once they pass, commit your code and move on.</p>

<blockquote>
<p>It&#39;s probably a good time to refactor some of the tests to keep them DRY. Do this on your own.</p>
</blockquote>


          
  <br><br>
  <a class="twitter-share-button" data-show-count="false" href="https://twitter.com/intent/tweet?text=Microservices with Docker, Flask, and React - Authorization&amp;url=http%3A%2F%2Ftestdriven.io/part-three-authorization&amp;via=RealPython" rel="nofollow" target="_blank" title="Share on Twitter"></a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>



          <div class="page-nav">
            
              <a class="prev btn left-align" href="/part-three-react-authentication">&laquo; React Authentication</a>
            
            
              <a class="next btn right-align" href="/part-three-update-component">Update Component &raquo;</a>
            
          </div>

        </div>

      </div>
    </div>

     <footer class="page-footer white">
  <div class="container footer-container center-align">
    <ul>
      <li>Content by Michael Herman (michael@realpython.com)</li>
      <li>&copy; Copyright 2017 <a href="http://realpython.com">Real Python</a></li>
    </ul>
  </div>
</footer>


    <script type="text/javascript" src="//code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/materialize/0.97.3/js/materialize.min.js"></script>

    
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-100160465-1', 'auto');
    ga('send', 'pageview');

  </script>



  </body>
</html>
