<!DOCTYPE html>
<html>

  <head>
  
    <title>Microservices with Docker, Flask, and React - JWT Setup</title>
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link
    rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/materialize/0.97.3/css/materialize.min.css"
  >
  <link
    rel="stylesheet"
    href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
  >
  <link
    href="//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic"
    rel="stylesheet"
    type="text/css"
  >
  <link
    href="//fonts.googleapis.com/css?family=Lato:900,300"
    rel="stylesheet"
    type="text/css"
  >
  <link href="/assets/css/styles.css" rel="stylesheet">
  <script
    src="//code.jquery.com/jquery-2.2.4.min.js"
    integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
    crossorigin="anonymous"
  ></script>
  <script
    type="text/javascript"
    src="/assets/js/main.js"
  ></script>
</head>


  <body>

    <nav class="red darken-1">
  <div class="container hide-on-small-and-down">
    <h3 class="brand-logo"><a href="/">Test Driven Development Courses</a></h3>
  </div>
  <div class="hide-on-med-and-up">
    <h3 class="brand-logo"><a href="/">TDD Courses</a></h3>
  <div>
</nav>


    <br>

    <div class="container">
      <div class="row">

        <div class="col m3 hide-on-small-and-down">
  <br>
  <div id="toc-block" class="collection hide-on-small-and-down">
    <ul class="collapsible collapsible-accordion">
      
        
          <li>
            <h5 data-part="1" class="collapsible-header  waves-effect waves-teal">
              Part 1
            </h5>
            <div class="collapsible-body">
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-one-intro"
            >Introduction</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-one-getting-started"
            >Getting Started</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-one-docker-config"
            >Docker Config</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-one-postgres-setup"
            >Postgres Setup</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-one-test-setup"
            >Test Setup</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-one-flask-blueprints"
            >Flask Blueprints</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-one-restful-routes"
            >RESTful Routes</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-one-aws-deployment"
            >Deployment</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-one-jinja-templates"
            >Jinja Templates</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-one-workflow"
            >Workflow</a>
          </li>
        </ul>
      
        
          <li>
            <h5 data-part="2" class="collapsible-header  waves-effect waves-teal">
              Part 2
            </h5>
            <div class="collapsible-body">
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-two-intro"
            >Introduction</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-two-project-refactor"
            >Project Refactor</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-two-code-coverage"
            >Code Coverage</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-two-continuous-integration"
            >Continuous Integration</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-two-react-setup"
            >React Setup</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-two-flask-deployment"
            >Flask Deployment</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-two-react-forms"
            >React Forms</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-two-react-docker"
            >React and Docker</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-two-flask-refactor"
            >Flask Refactor</a>
          </li>
        </ul>
      
        
          <li>
            <h5 data-part="3" class="collapsible-header  waves-effect waves-teal">
              Part 3
            </h5>
            <div class="collapsible-body">
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-three-intro"
            >Introduction</a>
          </li>
        </ul>
      
        
        <ul>
          <li>
            <a
              class="collection-item"
              href="/part-three-jwt-setup"
            >JWT Setup</a>
          </li>
        </ul>
      
    </div>
  </li>
    </ul>
  </div>
</div>


        <div class="col m9 hide-on-small-and-down">

          <h2>JWT Setup</h2>

          <p>In this lesson, we&#39;ll add JWT to the users service...</p>

<hr>

<p>If you&#39;re new to JWTs and/or token-based authentication, review the <a href="https://realpython.com/blog/python/token-based-authentication-with-flask/#introduction">Introduction</a> of the <a href="https://realpython.com/blog/python/token-based-authentication-with-flask">Token-Based Authentication With Flask</a> post. <a href="https://medium.com/technology-learning/how-we-solved-authentication-and-authorization-in-our-microservice-architecture-994539d1b6e6">How We Solved Authentication and Authorization in Our Microservice Architecture</a> is an excellent read as well.</p>

<p>Navigate to <em>flask-microservices-users</em>, activate the virtual environment, add the environment variables, and then run the tests to ensure they pass:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span><span class="nb">source </span>env/bin/activate
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span><span class="nb">export </span><span class="nv">APP_SETTINGS</span><span class="o">=</span>project.config.DevelopmentConfig
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span><span class="nb">export </span><span class="nv">DATABASE_URL</span><span class="o">=</span>postgres://postgres:postgres@localhost:5432/users_dev
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span><span class="nb">export </span><span class="nv">DATABASE_TEST_URL</span><span class="o">=</span>postgres://postgres:postgres@localhost:5432/users_test
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>python manage.py <span class="nb">test</span>
</code></pre></div>
<blockquote>
<p>You may need to change the username and password depending on your local Postgres config.</p>
</blockquote>

<h4 id="update-model">Update Model</h4>

<p>Let&#39;s make a few changes to the schema in <em>flask-microservices-users/project/api/models.py</em>:</p>

<ol>
<li><code>username</code> must be unique</li>
<li><code>email</code> must be unique</li>
<li><code>active</code> should default to <code>True</code></li>
</ol>

<p>We&#39;ll also add a password field, which will be hashed before it&#39;s added to the database:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">password</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div>
<p>With that, let&#39;s start with some tests. Add a new file to &quot;flask-microservices-users/project/tests&quot; called <em>test_user_model.py</em>. This file will hold tests related to our database model:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># project/tests/test_user_model.py</span>


<span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">project.api.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">project.tests.base</span> <span class="kn">import</span> <span class="n">BaseTestCase</span>


<span class="k">class</span> <span class="nc">TestUserModel</span><span class="p">(</span><span class="n">BaseTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>
</code></pre></div>
<p>Run the tests. You should see a single failure - <code>AssertionError: False is not true</code> - since <code>user.active</code> is <code>False</code>.</p>

<h4 id="flask-migrate">Flask Migrate</h4>

<p>Since we need to make a schema change, add <a href="https://flask-migrate.readthedocs.io/en/latest/">Flask-Migrate</a>:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>pip install flask-migrate<span class="o">==</span>2.0.4
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>pip freeze &gt; requirements.txt
</code></pre></div>
<p>In <em>flask-microservices-users/project/__init__.py</em> add the import, create a new instance, and update <code>create_app()</code>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># project/__init__.py</span>


<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span> <span class="nn">flask_cors</span> <span class="kn">import</span> <span class="n">CORS</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
<span class="kn">from</span> <span class="nn">flask_migrate</span> <span class="kn">import</span> <span class="n">Migrate</span>


<span class="c"># instantiate the db</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">()</span>
<span class="c"># instantiate flask migrate</span>
<span class="n">migrate</span> <span class="o">=</span> <span class="n">Migrate</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">create_app</span><span class="p">():</span>

    <span class="c"># instantiate the app</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

    <span class="c"># enable CORS</span>
    <span class="n">CORS</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

    <span class="c"># set config</span>
    <span class="n">app_settings</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;APP_SETTINGS&#39;</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">app_settings</span><span class="p">)</span>

    <span class="c"># set up extensions</span>
    <span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">migrate</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>

    <span class="c"># register blueprints</span>
    <span class="kn">from</span> <span class="nn">project.api.views</span> <span class="kn">import</span> <span class="n">users_blueprint</span>
    <span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">users_blueprint</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">app</span>
</code></pre></div>
<p>Then, add a new manager command to <em>flask-microservices-users/manage.py</em>, just below <code>manager = Manager(app)</code>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">manager</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="s">&#39;db&#39;</span><span class="p">,</span> <span class="n">MigrateCommand</span><span class="p">)</span>
</code></pre></div>
<p>Add the import as well:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">flask_migrate</span> <span class="kn">import</span> <span class="n">MigrateCommand</span>
</code></pre></div>
<p>Generate the migrations folder, add the initial migration, and then apply it to the database:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>python manage.py db init
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>python manage.py db migrate
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>python manage.py db upgrade
</code></pre></div>
<blockquote>
<p>Review the <a href="https://flask-migrate.readthedocs.io/en/latest/">documentation</a> for more info.</p>
</blockquote>

<p>Now, we can make the changes to the schema:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tableusers_</span> <span class="o">=</span> <span class="s">&quot;users&quot;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">active</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">created_at</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">created_at</span> <span class="o">=</span> <span class="n">created_at</span>
</code></pre></div>
<p>Again, run:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>python manage.py db migrate
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>python manage.py db upgrade
</code></pre></div>
<blockquote>
<p>Keep in mind that if you have any duplicate usernames and/or emails already in your database, you will get an error when trying to apply the migration to the database. You can either update the data or drop the db and start over.</p>
</blockquote>

<p>Run the tests again. They should pass! Before moving on, let&#39;s add a few more tests to <em>flask-microservices-users/project/tests/test_user_model.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">test_add_user_duplicate_username</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">duplicate_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test2.com&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">duplicate_user</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_add_user_duplicate_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">duplicate_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s">&#39;test@test2.com&#39;</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">duplicate_user</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span>
</code></pre></div>
<p>Notice how we didn&#39;t invoke <code>db.session.commit</code>. Instead, we passed it to <code>assertRaises()</code> and let it invoke it and assert the exception was raised.</p>

<p>Add the import:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="kn">import</span> <span class="n">IntegrityError</span>
</code></pre></div>
<p>Test again.</p>

<h4 id="refactor">Refactor</h4>

<p>Now is a good time to do some refactoring...</p>

<p>First, in <em>flask-microservices-users/project/tests/test_users.py</em>, rename <code>test_add_user_duplicate_user</code> to <code>test_add_user_duplicate_email</code>.</p>

<p>Also, did you notice that we added a new user a number of times in the <em>test_user_model.py</em> tests? Let&#39;s abstract out the <code>add_user</code> helper function from <em>test_users.py</em> to a utility file so we can use it in both test files.</p>

<p>Add a new file called &quot;utils.py&quot; to &quot;tests&quot;:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># project/tests/utils.py</span>


<span class="kn">import</span> <span class="nn">datetime</span>


<span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">project.api.models</span> <span class="kn">import</span> <span class="n">User</span>


<span class="k">def</span> <span class="nf">add_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span> <span class="n">created_at</span><span class="o">=</span><span class="n">created_at</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">user</span>
</code></pre></div>
<p>Then remove the helper from <em>test_users.py</em> and add the import to the same file:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">project.tests.utils</span> <span class="kn">import</span> <span class="n">add_user</span>
</code></pre></div>
<p>Refactor <em>test_user_model.py</em> like so:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># project/tests/test_user_model.py</span>


<span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="kn">import</span> <span class="n">IntegrityError</span>

<span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">project.api.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">project.tests.base</span> <span class="kn">import</span> <span class="n">BaseTestCase</span>
<span class="kn">from</span> <span class="nn">project.tests.utils</span> <span class="kn">import</span> <span class="n">add_user</span>

<span class="k">class</span> <span class="nc">TestUserModel</span><span class="p">(</span><span class="n">BaseTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">add_user</span><span class="p">(</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_add_user_duplicate_username</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">add_user</span><span class="p">(</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="n">duplicate_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test2.com&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">duplicate_user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_add_user_duplicate_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">add_user</span><span class="p">(</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="n">duplicate_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s">&#39;test@test2.com&#39;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">duplicate_user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span>
</code></pre></div>
<p>Run the tests again to ensure nothing broke.</p>

<h4 id="flask-bcrypt">Flask Bcrypt</h4>

<p>To manage password hashing, we&#39;ll use the <a href="https://flask-bcrypt.readthedocs.io/en/latest/">Flask-Bcrypt</a> extension:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>pip install flask-bcrypt<span class="o">==</span>0.7.1
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>pip freeze &gt; requirements.txt
</code></pre></div>
<p>Next, wire it up to the app in <em>flask-microservices-users/project/__init__.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># project/__init__.py</span>


<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span> <span class="nn">flask_cors</span> <span class="kn">import</span> <span class="n">CORS</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
<span class="kn">from</span> <span class="nn">flask_migrate</span> <span class="kn">import</span> <span class="n">Migrate</span>
<span class="kn">from</span> <span class="nn">flask_bcrypt</span> <span class="kn">import</span> <span class="n">Bcrypt</span>


<span class="c"># instantiate the extentions</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">()</span>
<span class="n">migrate</span> <span class="o">=</span> <span class="n">Migrate</span><span class="p">()</span>
<span class="n">bcrypt</span> <span class="o">=</span> <span class="n">Bcrypt</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">create_app</span><span class="p">():</span>

    <span class="c"># instantiate the app</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

    <span class="c"># enable CORS</span>
    <span class="n">CORS</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

    <span class="c"># set config</span>
    <span class="n">app_settings</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;APP_SETTINGS&#39;</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">app_settings</span><span class="p">)</span>

    <span class="c"># set up extensions</span>
    <span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">bcrypt</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">migrate</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>

    <span class="c"># register blueprints</span>
    <span class="kn">from</span> <span class="nn">project.api.views</span> <span class="kn">import</span> <span class="n">users_blueprint</span>
    <span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">users_blueprint</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">app</span>
</code></pre></div>
<p>Before we update the model, add the following test to <em>test_user_model.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">test_passwords_are_random</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">user_one</span> <span class="o">=</span> <span class="n">add_user</span><span class="p">(</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">,</span> <span class="s">&#39;test&#39;</span><span class="p">)</span>
    <span class="n">user_two</span> <span class="o">=</span> <span class="n">add_user</span><span class="p">(</span><span class="s">&#39;test@test2.com&#39;</span><span class="p">,</span> <span class="s">&#39;test@test2.com&#39;</span><span class="p">,</span> <span class="s">&#39;test&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">user_one</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="n">user_two</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</code></pre></div>
<p>Update the helper to take a password:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">add_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span>
        <span class="n">created_at</span><span class="o">=</span><span class="n">created_at</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">user</span>
</code></pre></div>
<p>Make sure to pass in an argument for the password to all tests that use the helper, anytime a new <code>User()</code> instance is created, and in the payload for the POST request to <code>/users</code>.</p>

<p>Finally, update <code>test_add_user()</code> from <em>test_user_model.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">test_add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">add_user</span><span class="p">(</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">,</span> <span class="s">&#39;test&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>
</code></pre></div>
<p>Run the migrations:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>python manage.py db migrate
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>python manage.py db upgrade
</code></pre></div>
<p>You should see a number of failures when you run the tests:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">db.session.add<span class="o">(</span>User<span class="o">(</span><span class="nv">username</span><span class="o">=</span>username, <span class="nv">email</span><span class="o">=</span>email<span class="o">))</span>
TypeError: __init__<span class="o">()</span> missing <span class="m">1</span> required positional argument: <span class="s1">&#39;password&#39;</span>
</code></pre></div>
<p>To get the tests green, update <code>add_user()</code> in &quot;flask-microservices-users/project/api/views.py&quot;:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="nd">@users_blueprint.route</span><span class="p">(</span><span class="s">&#39;/users&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">add_user</span><span class="p">():</span>
    <span class="n">post_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">post_data</span><span class="p">:</span>
        <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;fail&#39;</span><span class="p">,</span>
            <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;Invalid payload.&#39;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">)),</span> <span class="mi">400</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">post_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">post_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;email&#39;</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">post_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;password&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">User</span><span class="p">(</span>
                <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
                <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
                <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">))</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;success&#39;</span><span class="p">,</span>
                <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="n">f</span><span class="s">&#39;{email} was added!&#39;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">)),</span> <span class="mi">201</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;fail&#39;</span><span class="p">,</span>
                <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;Sorry. That email already exists.&#39;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">)),</span> <span class="mi">400</span>
    <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">IntegrityError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="p">()</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;fail&#39;</span><span class="p">,</span>
            <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;Invalid payload.&#39;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">)),</span> <span class="mi">400</span>
</code></pre></div>
<p>The tests should pass. Turning to the API, what if we don&#39;t pass a password in the payload? Write a test!</p>

<p><em>test_users.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">test_add_user_invalid_json_keys_no_password</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ensure error is thrown if the JSON object does not have a password key.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s">&#39;/users&#39;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">username</span><span class="o">=</span><span class="s">&#39;michael&#39;</span><span class="p">,</span>
                <span class="n">email</span><span class="o">=</span><span class="s">&#39;michael@realpython.com&#39;</span><span class="p">)),</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;Invalid payload.&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;fail&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">])</span>
</code></pre></div>
<p>You should see the following error when the tests are ran:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">raise ValueError<span class="o">(</span><span class="s1">&#39;Password must be non-empty.&#39;</span><span class="o">)</span>
ValueError: Password must be non-empty.
</code></pre></div>
<p>To fix, add a new exception handler to the try/except block in the <code>add_user</code> view handler:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="p">()</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
    <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;fail&#39;</span><span class="p">,</span>
        <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;Invalid payload.&#39;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">)),</span> <span class="mi">400</span>
</code></pre></div>
<p>Test again.</p>

<p>Finally, did you notice that the tests are running <em>much</em> slower? This is due to the <code>BCRYPT_LOG_ROUNDS</code> setting for Flask Bcrypt. Since we have not defined a value yet in the app config, Flask Bcrypt uses the <a href="https://github.com/maxcountryman/flask-bcrypt/blob/master/flask_bcrypt.py#L153">default value of 12</a>.</p>

<p>Update the test specs in <em>flask-microservices-users/project/tests/test_config.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">TestDevelopmentConfig</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">create_app</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="s">&#39;project.config.DevelopmentConfig&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">app</span>

    <span class="k">def</span> <span class="nf">test_app_is_development</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;SECRET_KEY&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="s">&#39;my_precious&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;DEBUG&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">current_app</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;SQLALCHEMY_DATABASE_URI&#39;</span><span class="p">]</span> <span class="o">==</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;DATABASE_URL&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;BCRYPT_LOG_ROUNDS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TestTestingConfig</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">create_app</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="s">&#39;project.config.TestingConfig&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">app</span>

    <span class="k">def</span> <span class="nf">test_app_is_testing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;SECRET_KEY&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="s">&#39;my_precious&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;DEBUG&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;TESTING&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;PRESERVE_CONTEXT_ON_EXCEPTION&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;SQLALCHEMY_DATABASE_URI&#39;</span><span class="p">]</span> <span class="o">==</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;DATABASE_TEST_URL&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;BCRYPT_LOG_ROUNDS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TestProductionConfig</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">create_app</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="s">&#39;project.config.ProductionConfig&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">app</span>

    <span class="k">def</span> <span class="nf">test_app_is_production</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;SECRET_KEY&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="s">&#39;my_precious&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;DEBUG&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;TESTING&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;BCRYPT_LOG_ROUNDS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span>
</code></pre></div>
<p>Make sure the tests fail, then update <em>flask-microservices-users/project/config.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># project/config.py</span>


<span class="kn">import</span> <span class="nn">os</span>


<span class="k">class</span> <span class="nc">BaseConfig</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Base configuration&quot;&quot;&quot;</span>
    <span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">TESTING</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">SQLALCHEMY_TRACK_MODIFICATIONS</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s">&#39;my_precious&#39;</span>
    <span class="n">BCRYPT_LOG_ROUNDS</span> <span class="o">=</span> <span class="mi">13</span>


<span class="k">class</span> <span class="nc">DevelopmentConfig</span><span class="p">(</span><span class="n">BaseConfig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Development configuration&quot;&quot;&quot;</span>
    <span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;DATABASE_URL&#39;</span><span class="p">)</span>
    <span class="n">BCRYPT_LOG_ROUNDS</span> <span class="o">=</span> <span class="mi">4</span>


<span class="k">class</span> <span class="nc">TestingConfig</span><span class="p">(</span><span class="n">BaseConfig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Testing configuration&quot;&quot;&quot;</span>
    <span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">TESTING</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;DATABASE_TEST_URL&#39;</span><span class="p">)</span>
    <span class="n">BCRYPT_LOG_ROUNDS</span> <span class="o">=</span> <span class="mi">4</span>


<span class="k">class</span> <span class="nc">ProductionConfig</span><span class="p">(</span><span class="n">BaseConfig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Production configuration&quot;&quot;&quot;</span>
    <span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;DATABASE_URL&#39;</span><span class="p">)</span>
</code></pre></div>
<p>Run the tests again!</p>

<ol>
<li>Do they pass?</li>
<li>Are they faster? (0.371s vs 4.322s on my end)</li>
</ol>

<p>With that, let&#39;s get JWT up and running...</p>

<h4 id="jwt-setup">JWT Setup</h4>

<ol>
<li>Test</li>
<li>Encode Token</li>
<li>Test</li>
<li>Decode Token</li>
</ol>

<hr>

<p>WIP</p>


          
  <br><br>
  <a class="twitter-share-button" data-show-count="false" href="https://twitter.com/intent/tweet?text=Microservices with Docker, Flask, and React - JWT Setup&amp;url=http%3A%2F%2Ftestdriven.io/part-three-jwt-setup&amp;via=RealPython" rel="nofollow" target="_blank" title="Share on Twitter"></a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>



          <div class="page-nav">
            
              <a class="prev btn left-align" href="/part-three-intro">&laquo; Introduction</a>
            
            
          </div>

        </div>

        <div class="hide-on-med-and-up">

          <h2>JWT Setup</h2>

          <p>In this lesson, we&#39;ll add JWT to the users service...</p>

<hr>

<p>If you&#39;re new to JWTs and/or token-based authentication, review the <a href="https://realpython.com/blog/python/token-based-authentication-with-flask/#introduction">Introduction</a> of the <a href="https://realpython.com/blog/python/token-based-authentication-with-flask">Token-Based Authentication With Flask</a> post. <a href="https://medium.com/technology-learning/how-we-solved-authentication-and-authorization-in-our-microservice-architecture-994539d1b6e6">How We Solved Authentication and Authorization in Our Microservice Architecture</a> is an excellent read as well.</p>

<p>Navigate to <em>flask-microservices-users</em>, activate the virtual environment, add the environment variables, and then run the tests to ensure they pass:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="nv">$ </span><span class="nb">source </span>env/bin/activate
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span><span class="nb">export </span><span class="nv">APP_SETTINGS</span><span class="o">=</span>project.config.DevelopmentConfig
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span><span class="nb">export </span><span class="nv">DATABASE_URL</span><span class="o">=</span>postgres://postgres:postgres@localhost:5432/users_dev
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span><span class="nb">export </span><span class="nv">DATABASE_TEST_URL</span><span class="o">=</span>postgres://postgres:postgres@localhost:5432/users_test
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>python manage.py <span class="nb">test</span>
</code></pre></div>
<blockquote>
<p>You may need to change the username and password depending on your local Postgres config.</p>
</blockquote>

<h4 id="update-model">Update Model</h4>

<p>Let&#39;s make a few changes to the schema in <em>flask-microservices-users/project/api/models.py</em>:</p>

<ol>
<li><code>username</code> must be unique</li>
<li><code>email</code> must be unique</li>
<li><code>active</code> should default to <code>True</code></li>
</ol>

<p>We&#39;ll also add a password field, which will be hashed before it&#39;s added to the database:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">password</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div>
<p>With that, let&#39;s start with some tests. Add a new file to &quot;flask-microservices-users/project/tests&quot; called <em>test_user_model.py</em>. This file will hold tests related to our database model:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># project/tests/test_user_model.py</span>


<span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">project.api.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">project.tests.base</span> <span class="kn">import</span> <span class="n">BaseTestCase</span>


<span class="k">class</span> <span class="nc">TestUserModel</span><span class="p">(</span><span class="n">BaseTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>
</code></pre></div>
<p>Run the tests. You should see a single failure - <code>AssertionError: False is not true</code> - since <code>user.active</code> is <code>False</code>.</p>

<h4 id="flask-migrate">Flask Migrate</h4>

<p>Since we need to make a schema change, add <a href="https://flask-migrate.readthedocs.io/en/latest/">Flask-Migrate</a>:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>pip install flask-migrate<span class="o">==</span>2.0.4
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>pip freeze &gt; requirements.txt
</code></pre></div>
<p>In <em>flask-microservices-users/project/__init__.py</em> add the import, create a new instance, and update <code>create_app()</code>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># project/__init__.py</span>


<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span> <span class="nn">flask_cors</span> <span class="kn">import</span> <span class="n">CORS</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
<span class="kn">from</span> <span class="nn">flask_migrate</span> <span class="kn">import</span> <span class="n">Migrate</span>


<span class="c"># instantiate the db</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">()</span>
<span class="c"># instantiate flask migrate</span>
<span class="n">migrate</span> <span class="o">=</span> <span class="n">Migrate</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">create_app</span><span class="p">():</span>

    <span class="c"># instantiate the app</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

    <span class="c"># enable CORS</span>
    <span class="n">CORS</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

    <span class="c"># set config</span>
    <span class="n">app_settings</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;APP_SETTINGS&#39;</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">app_settings</span><span class="p">)</span>

    <span class="c"># set up extensions</span>
    <span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">migrate</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>

    <span class="c"># register blueprints</span>
    <span class="kn">from</span> <span class="nn">project.api.views</span> <span class="kn">import</span> <span class="n">users_blueprint</span>
    <span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">users_blueprint</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">app</span>
</code></pre></div>
<p>Then, add a new manager command to <em>flask-microservices-users/manage.py</em>, just below <code>manager = Manager(app)</code>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">manager</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="s">&#39;db&#39;</span><span class="p">,</span> <span class="n">MigrateCommand</span><span class="p">)</span>
</code></pre></div>
<p>Add the import as well:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">flask_migrate</span> <span class="kn">import</span> <span class="n">MigrateCommand</span>
</code></pre></div>
<p>Generate the migrations folder, add the initial migration, and then apply it to the database:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>python manage.py db init
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>python manage.py db migrate
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>python manage.py db upgrade
</code></pre></div>
<blockquote>
<p>Review the <a href="https://flask-migrate.readthedocs.io/en/latest/">documentation</a> for more info.</p>
</blockquote>

<p>Now, we can make the changes to the schema:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tableusers_</span> <span class="o">=</span> <span class="s">&quot;users&quot;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">active</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">created_at</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">created_at</span> <span class="o">=</span> <span class="n">created_at</span>
</code></pre></div>
<p>Again, run:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>python manage.py db migrate
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>python manage.py db upgrade
</code></pre></div>
<blockquote>
<p>Keep in mind that if you have any duplicate usernames and/or emails already in your database, you will get an error when trying to apply the migration to the database. You can either update the data or drop the db and start over.</p>
</blockquote>

<p>Run the tests again. They should pass! Before moving on, let&#39;s add a few more tests to <em>flask-microservices-users/project/tests/test_user_model.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">test_add_user_duplicate_username</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">duplicate_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test2.com&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">duplicate_user</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_add_user_duplicate_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">duplicate_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="s">&#39;test@test2.com&#39;</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">duplicate_user</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span>
</code></pre></div>
<p>Notice how we didn&#39;t invoke <code>db.session.commit</code>. Instead, we passed it to <code>assertRaises()</code> and let it invoke it and assert the exception was raised.</p>

<p>Add the import:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="kn">import</span> <span class="n">IntegrityError</span>
</code></pre></div>
<p>Test again.</p>

<h4 id="refactor">Refactor</h4>

<p>Now is a good time to do some refactoring...</p>

<p>First, in <em>flask-microservices-users/project/tests/test_users.py</em>, rename <code>test_add_user_duplicate_user</code> to <code>test_add_user_duplicate_email</code>.</p>

<p>Also, did you notice that we added a new user a number of times in the <em>test_user_model.py</em> tests? Let&#39;s abstract out the <code>add_user</code> helper function from <em>test_users.py</em> to a utility file so we can use it in both test files.</p>

<p>Add a new file called &quot;utils.py&quot; to &quot;tests&quot;:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># project/tests/utils.py</span>


<span class="kn">import</span> <span class="nn">datetime</span>


<span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">project.api.models</span> <span class="kn">import</span> <span class="n">User</span>


<span class="k">def</span> <span class="nf">add_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span> <span class="n">created_at</span><span class="o">=</span><span class="n">created_at</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">user</span>
</code></pre></div>
<p>Then remove the helper from <em>test_users.py</em> and add the import to the same file:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">project.tests.utils</span> <span class="kn">import</span> <span class="n">add_user</span>
</code></pre></div>
<p>Refactor <em>test_user_model.py</em> like so:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># project/tests/test_user_model.py</span>


<span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="kn">import</span> <span class="n">IntegrityError</span>

<span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">project.api.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">project.tests.base</span> <span class="kn">import</span> <span class="n">BaseTestCase</span>
<span class="kn">from</span> <span class="nn">project.tests.utils</span> <span class="kn">import</span> <span class="n">add_user</span>

<span class="k">class</span> <span class="nc">TestUserModel</span><span class="p">(</span><span class="n">BaseTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">add_user</span><span class="p">(</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_add_user_duplicate_username</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">add_user</span><span class="p">(</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="n">duplicate_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test2.com&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">duplicate_user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_add_user_duplicate_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">add_user</span><span class="p">(</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="n">duplicate_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s">&#39;test@test2.com&#39;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">duplicate_user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span>
</code></pre></div>
<p>Run the tests again to ensure nothing broke.</p>

<h4 id="flask-bcrypt">Flask Bcrypt</h4>

<p>To manage password hashing, we&#39;ll use the <a href="https://flask-bcrypt.readthedocs.io/en/latest/">Flask-Bcrypt</a> extension:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>pip install flask-bcrypt<span class="o">==</span>0.7.1
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>pip freeze &gt; requirements.txt
</code></pre></div>
<p>Next, wire it up to the app in <em>flask-microservices-users/project/__init__.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># project/__init__.py</span>


<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span> <span class="nn">flask_cors</span> <span class="kn">import</span> <span class="n">CORS</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
<span class="kn">from</span> <span class="nn">flask_migrate</span> <span class="kn">import</span> <span class="n">Migrate</span>
<span class="kn">from</span> <span class="nn">flask_bcrypt</span> <span class="kn">import</span> <span class="n">Bcrypt</span>


<span class="c"># instantiate the extentions</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">()</span>
<span class="n">migrate</span> <span class="o">=</span> <span class="n">Migrate</span><span class="p">()</span>
<span class="n">bcrypt</span> <span class="o">=</span> <span class="n">Bcrypt</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">create_app</span><span class="p">():</span>

    <span class="c"># instantiate the app</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

    <span class="c"># enable CORS</span>
    <span class="n">CORS</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

    <span class="c"># set config</span>
    <span class="n">app_settings</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;APP_SETTINGS&#39;</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">app_settings</span><span class="p">)</span>

    <span class="c"># set up extensions</span>
    <span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">bcrypt</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">migrate</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>

    <span class="c"># register blueprints</span>
    <span class="kn">from</span> <span class="nn">project.api.views</span> <span class="kn">import</span> <span class="n">users_blueprint</span>
    <span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">users_blueprint</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">app</span>
</code></pre></div>
<p>Before we update the model, add the following test to <em>test_user_model.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">test_passwords_are_random</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">user_one</span> <span class="o">=</span> <span class="n">add_user</span><span class="p">(</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">,</span> <span class="s">&#39;test&#39;</span><span class="p">)</span>
    <span class="n">user_two</span> <span class="o">=</span> <span class="n">add_user</span><span class="p">(</span><span class="s">&#39;test@test2.com&#39;</span><span class="p">,</span> <span class="s">&#39;test@test2.com&#39;</span><span class="p">,</span> <span class="s">&#39;test&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">user_one</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="n">user_two</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
</code></pre></div>
<p>Update the helper to take a password:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">add_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span>
        <span class="n">created_at</span><span class="o">=</span><span class="n">created_at</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">user</span>
</code></pre></div>
<p>Make sure to pass in an argument for the password to all tests that use the helper, anytime a new <code>User()</code> instance is created, and in the payload for the POST request to <code>/users</code>.</p>

<p>Finally, update <code>test_add_user()</code> from <em>test_user_model.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">test_add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">add_user</span><span class="p">(</span><span class="s">&#39;test@test.com&#39;</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">,</span> <span class="s">&#39;test&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="s">&#39;test@test.com&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>
</code></pre></div>
<p>Run the migrations:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>python manage.py db migrate
<span class="o">(</span>env<span class="o">)</span><span class="nv">$ </span>python manage.py db upgrade
</code></pre></div>
<p>You should see a number of failures when you run the tests:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">db.session.add<span class="o">(</span>User<span class="o">(</span><span class="nv">username</span><span class="o">=</span>username, <span class="nv">email</span><span class="o">=</span>email<span class="o">))</span>
TypeError: __init__<span class="o">()</span> missing <span class="m">1</span> required positional argument: <span class="s1">&#39;password&#39;</span>
</code></pre></div>
<p>To get the tests green, update <code>add_user()</code> in &quot;flask-microservices-users/project/api/views.py&quot;:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="nd">@users_blueprint.route</span><span class="p">(</span><span class="s">&#39;/users&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">add_user</span><span class="p">():</span>
    <span class="n">post_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">post_data</span><span class="p">:</span>
        <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;fail&#39;</span><span class="p">,</span>
            <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;Invalid payload.&#39;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">)),</span> <span class="mi">400</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">post_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">post_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;email&#39;</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">post_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;password&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">User</span><span class="p">(</span>
                <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
                <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
                <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">))</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;success&#39;</span><span class="p">,</span>
                <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="n">f</span><span class="s">&#39;{email} was added!&#39;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">)),</span> <span class="mi">201</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;fail&#39;</span><span class="p">,</span>
                <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;Sorry. That email already exists.&#39;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">)),</span> <span class="mi">400</span>
    <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">IntegrityError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="p">()</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;fail&#39;</span><span class="p">,</span>
            <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;Invalid payload.&#39;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">)),</span> <span class="mi">400</span>
</code></pre></div>
<p>The tests should pass. Turning to the API, what if we don&#39;t pass a password in the payload? Write a test!</p>

<p><em>test_users.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">test_add_user_invalid_json_keys_no_password</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ensure error is thrown if the JSON object does not have a password key.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="s">&#39;/users&#39;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">username</span><span class="o">=</span><span class="s">&#39;michael&#39;</span><span class="p">,</span>
                <span class="n">email</span><span class="o">=</span><span class="s">&#39;michael@realpython.com&#39;</span><span class="p">)),</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s">&#39;application/json&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;Invalid payload.&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;fail&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">])</span>
</code></pre></div>
<p>You should see the following error when the tests are ran:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">raise ValueError<span class="o">(</span><span class="s1">&#39;Password must be non-empty.&#39;</span><span class="o">)</span>
ValueError: Password must be non-empty.
</code></pre></div>
<p>To fix, add a new exception handler to the try/except block in the <code>add_user</code> view handler:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="p">()</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
    <span class="n">response_object</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;fail&#39;</span><span class="p">,</span>
        <span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;Invalid payload.&#39;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">(</span><span class="n">response_object</span><span class="p">)),</span> <span class="mi">400</span>
</code></pre></div>
<p>Test again.</p>

<p>Finally, did you notice that the tests are running <em>much</em> slower? This is due to the <code>BCRYPT_LOG_ROUNDS</code> setting for Flask Bcrypt. Since we have not defined a value yet in the app config, Flask Bcrypt uses the <a href="https://github.com/maxcountryman/flask-bcrypt/blob/master/flask_bcrypt.py#L153">default value of 12</a>.</p>

<p>Update the test specs in <em>flask-microservices-users/project/tests/test_config.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">TestDevelopmentConfig</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">create_app</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="s">&#39;project.config.DevelopmentConfig&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">app</span>

    <span class="k">def</span> <span class="nf">test_app_is_development</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;SECRET_KEY&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="s">&#39;my_precious&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;DEBUG&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">current_app</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;SQLALCHEMY_DATABASE_URI&#39;</span><span class="p">]</span> <span class="o">==</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;DATABASE_URL&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;BCRYPT_LOG_ROUNDS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TestTestingConfig</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">create_app</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="s">&#39;project.config.TestingConfig&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">app</span>

    <span class="k">def</span> <span class="nf">test_app_is_testing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;SECRET_KEY&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="s">&#39;my_precious&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;DEBUG&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;TESTING&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;PRESERVE_CONTEXT_ON_EXCEPTION&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;SQLALCHEMY_DATABASE_URI&#39;</span><span class="p">]</span> <span class="o">==</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;DATABASE_TEST_URL&#39;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;BCRYPT_LOG_ROUNDS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TestProductionConfig</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">create_app</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="s">&#39;project.config.ProductionConfig&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">app</span>

    <span class="k">def</span> <span class="nf">test_app_is_production</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;SECRET_KEY&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="s">&#39;my_precious&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;DEBUG&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;TESTING&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;BCRYPT_LOG_ROUNDS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span>
</code></pre></div>
<p>Make sure the tests fail, then update <em>flask-microservices-users/project/config.py</em>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># project/config.py</span>


<span class="kn">import</span> <span class="nn">os</span>


<span class="k">class</span> <span class="nc">BaseConfig</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Base configuration&quot;&quot;&quot;</span>
    <span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">TESTING</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">SQLALCHEMY_TRACK_MODIFICATIONS</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s">&#39;my_precious&#39;</span>
    <span class="n">BCRYPT_LOG_ROUNDS</span> <span class="o">=</span> <span class="mi">13</span>


<span class="k">class</span> <span class="nc">DevelopmentConfig</span><span class="p">(</span><span class="n">BaseConfig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Development configuration&quot;&quot;&quot;</span>
    <span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;DATABASE_URL&#39;</span><span class="p">)</span>
    <span class="n">BCRYPT_LOG_ROUNDS</span> <span class="o">=</span> <span class="mi">4</span>


<span class="k">class</span> <span class="nc">TestingConfig</span><span class="p">(</span><span class="n">BaseConfig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Testing configuration&quot;&quot;&quot;</span>
    <span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">TESTING</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;DATABASE_TEST_URL&#39;</span><span class="p">)</span>
    <span class="n">BCRYPT_LOG_ROUNDS</span> <span class="o">=</span> <span class="mi">4</span>


<span class="k">class</span> <span class="nc">ProductionConfig</span><span class="p">(</span><span class="n">BaseConfig</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Production configuration&quot;&quot;&quot;</span>
    <span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;DATABASE_URL&#39;</span><span class="p">)</span>
</code></pre></div>
<p>Run the tests again!</p>

<ol>
<li>Do they pass?</li>
<li>Are they faster? (0.371s vs 4.322s on my end)</li>
</ol>

<p>With that, let&#39;s get JWT up and running...</p>

<h4 id="jwt-setup">JWT Setup</h4>

<ol>
<li>Test</li>
<li>Encode Token</li>
<li>Test</li>
<li>Decode Token</li>
</ol>

<hr>

<p>WIP</p>


          
  <br><br>
  <a class="twitter-share-button" data-show-count="false" href="https://twitter.com/intent/tweet?text=Microservices with Docker, Flask, and React - JWT Setup&amp;url=http%3A%2F%2Ftestdriven.io/part-three-jwt-setup&amp;via=RealPython" rel="nofollow" target="_blank" title="Share on Twitter"></a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>



          <div class="page-nav">
            
              <a class="prev btn left-align" href="/part-three-intro">&laquo; Introduction</a>
            
            
          </div>

        </div>

      </div>
    </div>

     <footer class="page-footer white">
  <div class="container footer-container center-align">
    <ul>
      <li>Content by Michael Herman (michael@realpython.com)</li>
      <li>&copy; Copyright 2017 <a href="http://realpython.com">Real Python</a></li>
    </ul>
  </div>
</footer>


    <script type="text/javascript" src="//code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/materialize/0.97.3/js/materialize.min.js"></script>

    
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-100160465-1', 'auto');
    ga('send', 'pageview');

  </script>



  </body>
</html>
