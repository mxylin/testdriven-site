<!DOCTYPE html>
<html>

  <head>
  
    <title>Microservices with Docker, Flask, and React - Docker Hub</title>
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="shortcut icon" type="image/png" href="/favicon.ico">
  <link
    rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css"
  >
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/icon?family=Material+Icons"
  >
  <link
    rel="stylesheet"
    href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
  >
  <link
    href="//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic"
    rel="stylesheet"
    type="text/css"
  >
  <link
    href="//fonts.googleapis.com/css?family=Lato:900,300"
    rel="stylesheet"
    type="text/css"
  >
  <link
    href="https://fonts.googleapis.com/css?family=Montserrat"
    rel="stylesheet"
    type="text/css"
  >
  <link
    href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css"
    rel="stylesheet"
    type="text/css"
  >
  <link href="/assets/css/styles.css?1515122354960472000" rel="stylesheet">
  <script
    src="//code.jquery.com/jquery-2.2.4.min.js"
    integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
    crossorigin="anonymous"
  ></script>
  <script
    type="text/javascript"
    src="/assets/js/main.js"
  ></script>
  <script
    type="text/javascript"
    src="https://gumroad.com/js/gumroad.js"
  ></script>
</head>


  <body>

    <nav class="indigo darken-4">
  <div class="nav-wrapper">
    <a href="/" class="nav-logo-container left">
      <img
        class="nav-logo" src="/assets/img/test_driven_io_full_logo_white_text.svg" alt="testdriven.io"
      />
    </a>
    <a href="/" class="brand-logo main-brand-logo center show-on-large hide-on-med-and-down">
      Test Driven Development Courses
    </a>
    <!-- <a href="/" class="brand-logo main-brand-logo hide-on-large-only">
      TDD Courses
    </a> -->
    <a href="#" data-activates="mobile-demo" class="right button-collapse"><i class="material-icons">menu</i></a>
    <ul class="right hide-on-med-and-down">
      <li><a href="/">Course</a></li>
      <li><a href="/course-contents">Contents</a></li>
    </ul>
    <ul class="side-nav" id="mobile-demo">
      <li><a href="/">Home</a></li>
      <li><a href="/">Course</a></li>
      <li><a href="/course-contents">Contents</a></li>
    </ul>
  </div>
</nav>


    <br>

    <div class="container">
      <div class="row">

        <div class="col m3 hide-on-small-and-down">
  <br>
  <div id="toc-block" class="collection hide-on-small-and-down">
    <ul class="collapsible collapsible-accordion">
      
        
          <li>
            <h5 data-part="1" class="collapsible-header  waves-effect waves-teal">
              Part 1
            </h5>
            <div class="collapsible-body">
        
        <ul>
          <li class="collection-li">
            <span>1.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-one-intro">
                Introduction
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>2.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-one-microservices">
                Microservices
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>3.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-one-app-overview">
                App Overview
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>4.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-one-getting-started">
                Getting Started
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>5.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-one-docker-config">
                Docker Config
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>6.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-one-postgres-setup">
                Postgres Setup
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>7.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-one-test-setup">
                Test Setup
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>8.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-one-flask-blueprints">
                Flask Blueprints
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>9.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-one-restful-routes">
                RESTful Routes
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>10.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-one-deployment">
                Deployment
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>11.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-one-jinja-templates">
                Jinja Templates
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>12.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-one-workflow">
                Workflow
              </a>
            </span>
          </li>
        </ul>
      
        
          <li>
            <h5 data-part="2" class="collapsible-header  waves-effect waves-teal">
              Part 2
            </h5>
            <div class="collapsible-body">
        
        <ul>
          <li class="collection-li">
            <span>1.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-two-intro">
                Introduction
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>2.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-two-code-coverage-and-quality">
                Code Coverage and Quality
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>3.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-two-continuous-integration">
                Continuous Integration
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>4.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-two-react-setup">
                React Setup
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>5.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-two-testing-react">
                Testing React
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>6.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-two-react-forms">
                React Forms
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>7.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-two-react-and-docker">
                React and Docker
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>8.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-two-next-steps">
                Next Steps
              </a>
            </span>
          </li>
        </ul>
      
        
          <li>
            <h5 data-part="3" class="collapsible-header  waves-effect waves-teal">
              Part 3
            </h5>
            <div class="collapsible-body">
        
        <ul>
          <li class="collection-li">
            <span>1.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-three-into">
                Introduction
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>2.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-three-flask-migrate">
                Flask Migrate
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>3.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-three-flask-bcrypt">
                Flask Bcrypt
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>4.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-three-jwt-setup">
                JWT Setup
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>5.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-three-auth-routes">
                Auth Routes
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>6.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-three-react-router">
                React Router
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>7.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-three-react-bootstrap">
                React Bootstrap
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>8.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-three-react-auth-one">
                React Authentication - part one
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>9.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-three-mocking-user-interaction">
                Mocking User Interaction
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>10.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-three-react-auth-two">
                React Authentication - part two
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>11.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-three-authorization">
                Authorization
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>12.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-three-update-component">
                Update Component
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>13.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-three-update-docker">
                Update Docker
              </a>
            </span>
          </li>
        </ul>
      
    </div>
  </li>
    </ul>
  </div>
</div>


        <div class="col m9 hide-on-small-and-down">

          <h2>Docker Hub</h2>

          
            <h5>Part 5, Lesson 2</h5>

            <div class="page-nav">
              
              
            </div>

            
  <br>
  <a class="twitter-share-button" data-show-count="false" href="https://twitter.com/intent/tweet?text=Microservices with Docker, Flask, and React - Docker Hub&amp;url=https%3A%2F%2Ftestdriven.io/part-five-docker-hub&amp;via=testdrivenio" rel="nofollow" target="_blank" title="Share on Twitter"></a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>



            <br><br>

          

          <p>Let&#39;s update the CI process to include <a href="https://docs.docker.com/docker-hub/">Docker Hub</a>, an image registry:</p>

<ol>
<li>Create a new feature branch</li>
<li>Open PR against the <code>master</code> branch</li>
<li>New build is triggered on Travis</li>
<li>If the tests pass, images are created and pushed to Docker Hub</li>
</ol>

<h4 id="docker-hub"><span style="font-family:'Montserrat', 'sans-serif';">Docker Hub</span></h4>

<p><a href="https://docs.docker.com/docker-hub/">Docker Hub</a> is an image registry, which is simply a service that stores Docker images - basically GitHub for Docker images.</p>

<blockquote>
<p>Review the following Stack Overflow <a href="https://stackoverflow.com/a/34004418/1799408">article</a> for more info on Docker Hub and image registries in general.</p>
</blockquote>

<p>Sign up for <a href="https://hub.docker.com/">Docker Hub</a> (if necessary), and then define the following environment variables within the <a href="https://docs.travis-ci.com/user/environment-variables/#Defining-Variables-in-Repository-Settings">Repository Settings</a> for <em>flask-microservices-main</em>:</p>

<ol>
<li>DOCKER_EMAIL - YOUREMAILATSOMETHING.COM</li>
<li>DOCKER_ID - YOUR_ID/USERNAME</li>
<li>DOCKER_PASSWORD - YOUR_PASSWORD</li>
</ol>

<p>Next, create four new repositories on Docker Hub:</p>

<ol>
<li><em>flask-microservices-users</em></li>
<li><em>flask-microservices-users_db</em></li>
<li><em>flask-microservices-client</em></li>
<li><em>flask-microservices-swagger</em></li>
<li><em>flask-microservices-nginx</em></li>
</ol>

<blockquote>
<p>Keep in mind that we will be storing these repositories publicly so do not add any sensitive info to the images on the build.</p>
</blockquote>

<h4 id="users"><span style="font-family:'Montserrat', 'sans-serif';">Users</span></h4>

<p>Let&#39;s update the <em>.travis.yml</em> file in <em>flask-microservices-main</em>:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="l l-Scalar l-Scalar-Plain">language</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">node_js</span>
<span class="l l-Scalar l-Scalar-Plain">node_js</span><span class="p p-Indicator">:</span> <span class="s">&#39;7&#39;</span>

<span class="l l-Scalar l-Scalar-Plain">before_install</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">stty cols 80</span>

<span class="l l-Scalar l-Scalar-Plain">dist</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">trusty</span>
<span class="l l-Scalar l-Scalar-Plain">sudo</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">required</span>

<span class="l l-Scalar l-Scalar-Plain">addons</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">apt</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">sources</span><span class="p p-Indicator">:</span>
     <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">google-chrome</span>
    <span class="l l-Scalar l-Scalar-Plain">packages</span><span class="p p-Indicator">:</span>
     <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">google-chrome-stable</span>

<span class="l l-Scalar l-Scalar-Plain">services</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker</span>

<span class="l l-Scalar l-Scalar-Plain">env</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">global</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">DOCKER_COMPOSE_VERSION=1.11.2</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">COMMIT=${TRAVIS_COMMIT::8}</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">USERS=flask-microservices-users</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">USERS_REPO=https://github.com/realpython/$USERS.git</span>

<span class="l l-Scalar l-Scalar-Plain">before_install</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sudo rm /usr/local/bin/docker-compose</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` &gt; docker-compose</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">chmod +x docker-compose</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sudo mv docker-compose /usr/local/bin</span>

<span class="l l-Scalar l-Scalar-Plain">before_script</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">export TEST_URL=http://127.0.0.1</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">export REACT_APP_USERS_SERVICE_URL=http://127.0.0.1</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">export SECRET_KEY=my_precious</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">export DISPLAY=:99.0</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sh -e /etc/init.d/xvfb start</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sleep 3</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker-compose -f docker-compose-ci.yml up -d --build</span>

<span class="l l-Scalar l-Scalar-Plain">script</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker-compose -f docker-compose-ci.yml run users-service python manage.py test</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker-compose -f docker-compose-ci.yml run users-service python manage.py recreate_db</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">testcafe chrome e2e</span>

<span class="l l-Scalar l-Scalar-Plain">after_script</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker-compose down</span>

<span class="l l-Scalar l-Scalar-Plain">after_success</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker login -e $DOCKER_EMAIL -u $DOCKER_ID -p $DOCKER_PASSWORD</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">export TAG=`if [ &quot;$TRAVIS_BRANCH&quot; == &quot;master&quot; ]; then echo &quot;latest&quot;; else echo $TRAVIS_BRANCH ; fi`</span>
  <span class="c1"># users</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker build $USERS_REPO -t $USERS:$COMMIT</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker tag $USERS:$COMMIT $DOCKER_ID/$USERS:$TAG</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker push $DOCKER_ID/$USERS</span>
</code></pre></div>
<p>What changed?</p>

<ol>
<li>Environment variables:

<ol>
<li><code>COMMIT=${TRAVIS_COMMIT::8}</code> - sets a new environment variable, called <code>COMMIT</code>, which contains the first 8 characters of the git commit hash.</li>
<li><code>USERS</code> - defines the name of the Git repo and image name.</li>
<li><code>USERS_REPO</code> - defines the full GitHub URL.</li>
</ol></li>
<li>Finally, within <code>after_success</code>, we login to the Docker Hub registry, generate a tag based on the branch name, build an image from the <em>Dockerfile</em>, tag the image, and then push the image to Docker Hub.</li>
</ol>

<blockquote>
<p>Update the value of <code>USERS_REPO</code> to your repo.</p>
</blockquote>

<p>We also referenced a new Docker Compose file, <em>docker-compose-ci.yml</em>:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span> <span class="s">&#39;2.1&#39;</span>

<span class="l l-Scalar l-Scalar-Plain">services</span><span class="p p-Indicator">:</span>

  <span class="l l-Scalar l-Scalar-Plain">users-db</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">container_name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">users-db</span>
    <span class="l l-Scalar l-Scalar-Plain">build</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">context</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">https://github.com/realpython/flask-microservices-users.git#master:project/db</span>
    <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">5435:5432</span>  <span class="c1"># expose ports - HOST:CONTAINER</span>
    <span class="l l-Scalar l-Scalar-Plain">environment</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">POSTGRES_USER=postgres</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD=postgres</span>
    <span class="l l-Scalar l-Scalar-Plain">healthcheck</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">test</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">exit 0</span>

  <span class="l l-Scalar l-Scalar-Plain">users-service</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">container_name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">users-service</span>
    <span class="l l-Scalar l-Scalar-Plain">build</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">context</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">https://github.com/realpython/flask-microservices-users.git</span>
    <span class="l l-Scalar l-Scalar-Plain">expose</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;5000&#39;</span>
    <span class="l l-Scalar l-Scalar-Plain">environment</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">APP_SETTINGS=project.config.StagingConfig</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">DATABASE_URL=postgres://postgres:postgres@users-db:5432/users_staging</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">DATABASE_TEST_URL=postgres://postgres:postgres@users-db:5432/users_test</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">SECRET_KEY=${SECRET_KEY}</span>
    <span class="l l-Scalar l-Scalar-Plain">depends_on</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">users-db</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">condition</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">service_healthy</span>
    <span class="l l-Scalar l-Scalar-Plain">links</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">users-db</span>
    <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">gunicorn -b 0.0.0.0:5000 manage:app</span>

  <span class="l l-Scalar l-Scalar-Plain">nginx</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">container_name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx</span>
    <span class="l l-Scalar l-Scalar-Plain">build</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">./nginx/</span>
    <span class="l l-Scalar l-Scalar-Plain">restart</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">always</span>
    <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">80:80</span>
    <span class="l l-Scalar l-Scalar-Plain">depends_on</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">users-service</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">condition</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">service_started</span>
      <span class="l l-Scalar l-Scalar-Plain">web-service</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">condition</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">service_started</span>
    <span class="l l-Scalar l-Scalar-Plain">links</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">users-service</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">web-service</span>

  <span class="l l-Scalar l-Scalar-Plain">web-service</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">container_name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">web-service</span>
    <span class="l l-Scalar l-Scalar-Plain">build</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">context</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">https://github.com/realpython/flask-microservices-client.git</span>
      <span class="l l-Scalar l-Scalar-Plain">args</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">NODE_ENV=development</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">REACT_APP_USERS_SERVICE_URL=${REACT_APP_USERS_SERVICE_URL}</span>
    <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;9000:9000&#39;</span> <span class="c1"># expose ports - HOST:CONTAINER</span>
    <span class="l l-Scalar l-Scalar-Plain">depends_on</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">users-service</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">condition</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">service_started</span>
    <span class="l l-Scalar l-Scalar-Plain">links</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">users-service</span>

  <span class="l l-Scalar l-Scalar-Plain">swagger</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">container_name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">swagger</span>
    <span class="l l-Scalar l-Scalar-Plain">build</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">context</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">https://github.com/realpython/flask-microservices-swagger.git</span>
    <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;8080:8080&#39;</span> <span class="c1"># expose ports - HOST:CONTAINER</span>
    <span class="l l-Scalar l-Scalar-Plain">environment</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">API_URL=https://raw.githubusercontent.com/realpython/flask-microservices-swagger/master/swagger.json</span>
    <span class="l l-Scalar l-Scalar-Plain">depends_on</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">users-service</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">condition</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">service_started</span>
</code></pre></div>
<p>To test, commit your code and then push to GitHub. Make sure the build passes on Travis and that a new <a href="https://docs.docker.com/docker-hub/repos/#viewing-repository-tags">tag</a> was added to Docker Hub.</p>

<h4 id="users-db"><span style="font-family:'Montserrat', 'sans-serif';">Users DB</span></h4>

<p>For the users database, add the environment variables to <em>.travis.yml</em>:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">USERS_DB=flask-microservices-users_db</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">USERS_DB_REPO=https://github.com/realpython/$USERS.git#master:project/db</span>
</code></pre></div>
<p>Then add the following to <code>after_success</code>:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="c1"># users db</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker build $USERS_DB_REPO -t $USERS_DB:$COMMIT</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker tag $USERS_DB:$COMMIT $DOCKER_ID/$USERS_DB:$TAG</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker push $DOCKER_ID/$USERS_DB</span>
</code></pre></div>
<p>Commit, push, and ensure all is well.</p>

<p>For each of the next three services, we need to make the updates to <em>.travis.yml</em>, commit and push the code, and then ensure the build passes and the tag is added to Docker Hub....</p>

<h4 id="web"><span style="font-family:'Montserrat', 'sans-serif';">Web</span></h4>

<p>Environment variables:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">CLIENT=flask-microservices-client</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">CLIENT_REPO=https://github.com/realpython/$CLIENT.git</span>
</code></pre></div>
<p><code>after_success</code>:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="c1"># client</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker build $CLIENT_REPO -t $CLIENT:$COMMIT</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker tag $CLIENT:$COMMIT $DOCKER_ID/$CLIENT:$TAG</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker push $DOCKER_ID/$CLIENT</span>
</code></pre></div>
<h4 id="swagger"><span style="font-family:'Montserrat', 'sans-serif';">Swagger</span></h4>

<p>Environment variables:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">SWAGGER=flask-microservices-swagger</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">SWAGGER_REPO=https://github.com/realpython/$SWAGGER.git</span>
</code></pre></div>
<p><code>after_success</code>:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="c1"># swagger</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker build $SWAGGER_REPO -t $SWAGGER:$COMMIT</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker tag $SWAGGER:$COMMIT $DOCKER_ID/$SWAGGER:$TAG</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker push $DOCKER_ID/$SWAGGER</span>
</code></pre></div>
<h4 id="nginx"><span style="font-family:'Montserrat', 'sans-serif';">Nginx</span></h4>

<p>Environment variables:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">NGINX=flask-microservices-nginx</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">NGINX_REPO=https://github.com/realpython/flask-microservices-main.git#master:nginx</span>
</code></pre></div>
<p><code>after_success</code>:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="c1"># nginx</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker build $NGINX_REPO -t $NGINX:$COMMIT</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker tag $NGINX:$COMMIT $DOCKER_ID/$NGINX:$TAG</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker push $DOCKER_ID/$NGINX</span>
</code></pre></div>
<h4 id="scripts"><span style="font-family:'Montserrat', 'sans-serif';">Scripts</span></h4>

<p>Since we only want the <code>after_success</code> to run when the branch is <code>master</code>, let&#39;s create a simple shell script:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span></span><span class="ch">#!/bin/sh</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$TRAVIS_BRANCH</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;master&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  docker login -e <span class="nv">$DOCKER_EMAIL</span> -u <span class="nv">$DOCKER_ID</span> -p <span class="nv">$DOCKER_PASSWORD</span>
  <span class="nb">export</span> <span class="nv">TAG</span><span class="o">=</span><span class="sb">`</span><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$TRAVIS_BRANCH</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;master&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="nb">echo</span> <span class="s2">&quot;latest&quot;</span><span class="p">;</span> <span class="k">else</span> <span class="nb">echo</span> <span class="nv">$TRAVIS_BRANCH</span> <span class="p">;</span> <span class="k">fi</span><span class="sb">`</span>
  <span class="c1"># users</span>
  docker build <span class="nv">$USERS_REPO</span> -t <span class="nv">$USERS</span>:<span class="nv">$COMMIT</span>
  docker tag <span class="nv">$USERS</span>:<span class="nv">$COMMIT</span> <span class="nv">$DOCKER_ID</span>/<span class="nv">$USERS</span>:<span class="nv">$TAG</span>
  docker push <span class="nv">$DOCKER_ID</span>/<span class="nv">$USERS</span>
  <span class="c1"># users db</span>
  docker build <span class="nv">$USERS_DB_REPO</span> -t <span class="nv">$USERS_DB</span>:<span class="nv">$COMMIT</span>
  docker tag <span class="nv">$USERS_DB</span>:<span class="nv">$COMMIT</span> <span class="nv">$DOCKER_ID</span>/<span class="nv">$USERS_DB</span>:<span class="nv">$TAG</span>
  docker push <span class="nv">$DOCKER_ID</span>/<span class="nv">$USERS_DB</span>
  <span class="c1"># client</span>
  docker build <span class="nv">$CLIENT_REPO</span> -t <span class="nv">$CLIENT</span>:<span class="nv">$COMMIT</span>
  docker tag <span class="nv">$CLIENT</span>:<span class="nv">$COMMIT</span> <span class="nv">$DOCKER_ID</span>/<span class="nv">$CLIENT</span>:<span class="nv">$TAG</span>
  docker push <span class="nv">$DOCKER_ID</span>/<span class="nv">$CLIENT</span>
  <span class="c1"># swagger</span>
  docker build <span class="nv">$SWAGGER_REPO</span> -t <span class="nv">$SWAGGER</span>:<span class="nv">$COMMIT</span>
  docker tag <span class="nv">$SWAGGER</span>:<span class="nv">$COMMIT</span> <span class="nv">$DOCKER_ID</span>/<span class="nv">$SWAGGER</span>:<span class="nv">$TAG</span>
  docker push <span class="nv">$DOCKER_ID</span>/<span class="nv">$SWAGGER</span>
  <span class="c1"># nginx</span>
  docker build <span class="nv">$NGINX_REPO</span> -t <span class="nv">$NGINX</span>:<span class="nv">$COMMIT</span>
  docker tag <span class="nv">$NGINX</span>:<span class="nv">$COMMIT</span> <span class="nv">$DOCKER_ID</span>/<span class="nv">$NGINX</span>:<span class="nv">$TAG</span>
  docker push <span class="nv">$DOCKER_ID</span>/<span class="nv">$NGINX</span>
<span class="k">fi</span>
</code></pre></div>
<p>Save this as <em>docker_push.sh</em> within <em>flask-microservices-main</em>, and then update <code>after_success</code>:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="l l-Scalar l-Scalar-Plain">after_success</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">bash ./docker_push.sh</span>
</code></pre></div>
<p>We can speed up the building of new images by first pulling in the latest image from Docker Hub. Add a new script called <em>docker_build.sh</em> to the project root:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span></span><span class="ch">#!/bin/sh</span>

docker login -e <span class="nv">$DOCKER_EMAIL</span> -u <span class="nv">$DOCKER_ID</span> -p <span class="nv">$DOCKER_PASSWORD</span>
docker pull <span class="nv">$DOCKER_ID</span>/<span class="nv">$USERS</span>
docker pull <span class="nv">$DOCKER_ID</span>/<span class="nv">$USERS_DB</span>
docker pull <span class="nv">$DOCKER_ID</span>/<span class="nv">$CLIENT</span>
docker pull <span class="nv">$DOCKER_ID</span>/<span class="nv">$SWAGGER</span>
docker pull <span class="nv">$DOCKER_ID</span>/<span class="nv">$NGINX</span>

docker-compose -f docker-compose-ci.yml up -d --build
</code></pre></div>
<blockquote>
<p>Want to speed things up even more? <a href="https://github.com/start-jsk/jsk_apc/commit/7c12afa1c8c460f1b148c6ca887203d915fa9846">Cache images on Travis</a>.</p>
</blockquote>

<p>Update the <code>before_script</code> in <em>.travis.yml</em>:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="l l-Scalar l-Scalar-Plain">before_script</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">export TEST_URL=http://127.0.0.1</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">export REACT_APP_USERS_SERVICE_URL=http://127.0.0.1</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">export SECRET_KEY=my_precious</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">export DISPLAY=:99.0</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sh -e /etc/init.d/xvfb start</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sleep 3</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">bash ./docker_build.sh</span>
</code></pre></div>
<p>To test create a new branch feature branch and push your code to GitHub. A new build should be triggered, but it should not run any code within the <code>if</code> block within <em>docker_push.sh</em>. Merge your code to master in GitHub, which will trigger another new build on Travis. This time, the script should fire.</p>

<h4 id="architecture"><span style="font-family:'Montserrat', 'sans-serif';">Architecture</span></h4>

<table><thead>
<tr>
<th>Name</th>
<th>Repo</th>
<th>Image</th>
<th>Container</th>
<th>Tech</th>
</tr>
</thead><tbody>
<tr>
<td>Users API</td>
<td><a href="https://github.com/realpython/flask-microservices-users">users</a></td>
<td><a href="https://hub.docker.com/r/realpython/flask-microservices-users">users</a></td>
<td><code>users-service</code></td>
<td>Flask, gunicorn</td>
</tr>
<tr>
<td>Users DB</td>
<td><a href="https://github.com/realpython/flask-microservices-users/tree/master/project/db">users</a></td>
<td><a href="https://hub.docker.com/r/realpython/flask-microservices-users_db">users_db</a></td>
<td><code>users-db</code></td>
<td>Postgres</td>
</tr>
<tr>
<td>Client</td>
<td><a href="https://github.com/realpython/flask-microservices-client">client</a></td>
<td><a href="https://hub.docker.com/r/realpython/flask-microservices-client">client</a></td>
<td><code>web-service</code></td>
<td>React, React-Router</td>
</tr>
<tr>
<td>Swagger</td>
<td><a href="https://github.com/realpython/flask-microservices-swagger">swagger</a></td>
<td><a href="https://hub.docker.com/r/realpython/flask-microservices-swagger">swagger</a></td>
<td><code>swagger</code></td>
<td>Swagger UI</td>
</tr>
<tr>
<td>e2e Tests</td>
<td><a href="https://github.com/realpython/flask-microservices-main/tree/master/e2e">main</a></td>
<td>N/A</td>
<td>N/A</td>
<td>TestCafe</td>
</tr>
<tr>
<td>Nginx</td>
<td><a href="https://github.com/realpython/flask-microservices-main/tree/master/nginx">main</a></td>
<td><a href="https://hub.docker.com/r/realpython/flask-microservices-nginx">nginx</a></td>
<td><code>nginx</code></td>
<td>Nginx</td>
</tr>
</tbody></table>


          <div class="page-nav">
            
            
          </div>

          
  <br>
  <a class="twitter-share-button" data-show-count="false" href="https://twitter.com/intent/tweet?text=Microservices with Docker, Flask, and React - Docker Hub&amp;url=https%3A%2F%2Ftestdriven.io/part-five-docker-hub&amp;via=testdrivenio" rel="nofollow" target="_blank" title="Share on Twitter"></a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>



        </div>

        <div class="hide-on-med-and-up">

          <h2>Docker Hub</h2>

          <p>Let&#39;s update the CI process to include <a href="https://docs.docker.com/docker-hub/">Docker Hub</a>, an image registry:</p>

<ol>
<li>Create a new feature branch</li>
<li>Open PR against the <code>master</code> branch</li>
<li>New build is triggered on Travis</li>
<li>If the tests pass, images are created and pushed to Docker Hub</li>
</ol>

<h4 id="docker-hub"><span style="font-family:'Montserrat', 'sans-serif';">Docker Hub</span></h4>

<p><a href="https://docs.docker.com/docker-hub/">Docker Hub</a> is an image registry, which is simply a service that stores Docker images - basically GitHub for Docker images.</p>

<blockquote>
<p>Review the following Stack Overflow <a href="https://stackoverflow.com/a/34004418/1799408">article</a> for more info on Docker Hub and image registries in general.</p>
</blockquote>

<p>Sign up for <a href="https://hub.docker.com/">Docker Hub</a> (if necessary), and then define the following environment variables within the <a href="https://docs.travis-ci.com/user/environment-variables/#Defining-Variables-in-Repository-Settings">Repository Settings</a> for <em>flask-microservices-main</em>:</p>

<ol>
<li>DOCKER_EMAIL - YOUREMAILATSOMETHING.COM</li>
<li>DOCKER_ID - YOUR_ID/USERNAME</li>
<li>DOCKER_PASSWORD - YOUR_PASSWORD</li>
</ol>

<p>Next, create four new repositories on Docker Hub:</p>

<ol>
<li><em>flask-microservices-users</em></li>
<li><em>flask-microservices-users_db</em></li>
<li><em>flask-microservices-client</em></li>
<li><em>flask-microservices-swagger</em></li>
<li><em>flask-microservices-nginx</em></li>
</ol>

<blockquote>
<p>Keep in mind that we will be storing these repositories publicly so do not add any sensitive info to the images on the build.</p>
</blockquote>

<h4 id="users"><span style="font-family:'Montserrat', 'sans-serif';">Users</span></h4>

<p>Let&#39;s update the <em>.travis.yml</em> file in <em>flask-microservices-main</em>:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="l l-Scalar l-Scalar-Plain">language</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">node_js</span>
<span class="l l-Scalar l-Scalar-Plain">node_js</span><span class="p p-Indicator">:</span> <span class="s">&#39;7&#39;</span>

<span class="l l-Scalar l-Scalar-Plain">before_install</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">stty cols 80</span>

<span class="l l-Scalar l-Scalar-Plain">dist</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">trusty</span>
<span class="l l-Scalar l-Scalar-Plain">sudo</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">required</span>

<span class="l l-Scalar l-Scalar-Plain">addons</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">apt</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">sources</span><span class="p p-Indicator">:</span>
     <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">google-chrome</span>
    <span class="l l-Scalar l-Scalar-Plain">packages</span><span class="p p-Indicator">:</span>
     <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">google-chrome-stable</span>

<span class="l l-Scalar l-Scalar-Plain">services</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker</span>

<span class="l l-Scalar l-Scalar-Plain">env</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">global</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">DOCKER_COMPOSE_VERSION=1.11.2</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">COMMIT=${TRAVIS_COMMIT::8}</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">USERS=flask-microservices-users</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">USERS_REPO=https://github.com/realpython/$USERS.git</span>

<span class="l l-Scalar l-Scalar-Plain">before_install</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sudo rm /usr/local/bin/docker-compose</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` &gt; docker-compose</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">chmod +x docker-compose</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sudo mv docker-compose /usr/local/bin</span>

<span class="l l-Scalar l-Scalar-Plain">before_script</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">export TEST_URL=http://127.0.0.1</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">export REACT_APP_USERS_SERVICE_URL=http://127.0.0.1</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">export SECRET_KEY=my_precious</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">export DISPLAY=:99.0</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sh -e /etc/init.d/xvfb start</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sleep 3</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker-compose -f docker-compose-ci.yml up -d --build</span>

<span class="l l-Scalar l-Scalar-Plain">script</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker-compose -f docker-compose-ci.yml run users-service python manage.py test</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker-compose -f docker-compose-ci.yml run users-service python manage.py recreate_db</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">testcafe chrome e2e</span>

<span class="l l-Scalar l-Scalar-Plain">after_script</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker-compose down</span>

<span class="l l-Scalar l-Scalar-Plain">after_success</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker login -e $DOCKER_EMAIL -u $DOCKER_ID -p $DOCKER_PASSWORD</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">export TAG=`if [ &quot;$TRAVIS_BRANCH&quot; == &quot;master&quot; ]; then echo &quot;latest&quot;; else echo $TRAVIS_BRANCH ; fi`</span>
  <span class="c1"># users</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker build $USERS_REPO -t $USERS:$COMMIT</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker tag $USERS:$COMMIT $DOCKER_ID/$USERS:$TAG</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker push $DOCKER_ID/$USERS</span>
</code></pre></div>
<p>What changed?</p>

<ol>
<li>Environment variables:

<ol>
<li><code>COMMIT=${TRAVIS_COMMIT::8}</code> - sets a new environment variable, called <code>COMMIT</code>, which contains the first 8 characters of the git commit hash.</li>
<li><code>USERS</code> - defines the name of the Git repo and image name.</li>
<li><code>USERS_REPO</code> - defines the full GitHub URL.</li>
</ol></li>
<li>Finally, within <code>after_success</code>, we login to the Docker Hub registry, generate a tag based on the branch name, build an image from the <em>Dockerfile</em>, tag the image, and then push the image to Docker Hub.</li>
</ol>

<blockquote>
<p>Update the value of <code>USERS_REPO</code> to your repo.</p>
</blockquote>

<p>We also referenced a new Docker Compose file, <em>docker-compose-ci.yml</em>:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span> <span class="s">&#39;2.1&#39;</span>

<span class="l l-Scalar l-Scalar-Plain">services</span><span class="p p-Indicator">:</span>

  <span class="l l-Scalar l-Scalar-Plain">users-db</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">container_name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">users-db</span>
    <span class="l l-Scalar l-Scalar-Plain">build</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">context</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">https://github.com/realpython/flask-microservices-users.git#master:project/db</span>
    <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">5435:5432</span>  <span class="c1"># expose ports - HOST:CONTAINER</span>
    <span class="l l-Scalar l-Scalar-Plain">environment</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">POSTGRES_USER=postgres</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">POSTGRES_PASSWORD=postgres</span>
    <span class="l l-Scalar l-Scalar-Plain">healthcheck</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">test</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">exit 0</span>

  <span class="l l-Scalar l-Scalar-Plain">users-service</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">container_name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">users-service</span>
    <span class="l l-Scalar l-Scalar-Plain">build</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">context</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">https://github.com/realpython/flask-microservices-users.git</span>
    <span class="l l-Scalar l-Scalar-Plain">expose</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;5000&#39;</span>
    <span class="l l-Scalar l-Scalar-Plain">environment</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">APP_SETTINGS=project.config.StagingConfig</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">DATABASE_URL=postgres://postgres:postgres@users-db:5432/users_staging</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">DATABASE_TEST_URL=postgres://postgres:postgres@users-db:5432/users_test</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">SECRET_KEY=${SECRET_KEY}</span>
    <span class="l l-Scalar l-Scalar-Plain">depends_on</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">users-db</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">condition</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">service_healthy</span>
    <span class="l l-Scalar l-Scalar-Plain">links</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">users-db</span>
    <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">gunicorn -b 0.0.0.0:5000 manage:app</span>

  <span class="l l-Scalar l-Scalar-Plain">nginx</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">container_name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx</span>
    <span class="l l-Scalar l-Scalar-Plain">build</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">./nginx/</span>
    <span class="l l-Scalar l-Scalar-Plain">restart</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">always</span>
    <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">80:80</span>
    <span class="l l-Scalar l-Scalar-Plain">depends_on</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">users-service</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">condition</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">service_started</span>
      <span class="l l-Scalar l-Scalar-Plain">web-service</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">condition</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">service_started</span>
    <span class="l l-Scalar l-Scalar-Plain">links</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">users-service</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">web-service</span>

  <span class="l l-Scalar l-Scalar-Plain">web-service</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">container_name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">web-service</span>
    <span class="l l-Scalar l-Scalar-Plain">build</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">context</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">https://github.com/realpython/flask-microservices-client.git</span>
      <span class="l l-Scalar l-Scalar-Plain">args</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">NODE_ENV=development</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">REACT_APP_USERS_SERVICE_URL=${REACT_APP_USERS_SERVICE_URL}</span>
    <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;9000:9000&#39;</span> <span class="c1"># expose ports - HOST:CONTAINER</span>
    <span class="l l-Scalar l-Scalar-Plain">depends_on</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">users-service</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">condition</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">service_started</span>
    <span class="l l-Scalar l-Scalar-Plain">links</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">users-service</span>

  <span class="l l-Scalar l-Scalar-Plain">swagger</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">container_name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">swagger</span>
    <span class="l l-Scalar l-Scalar-Plain">build</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">context</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">https://github.com/realpython/flask-microservices-swagger.git</span>
    <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;8080:8080&#39;</span> <span class="c1"># expose ports - HOST:CONTAINER</span>
    <span class="l l-Scalar l-Scalar-Plain">environment</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">API_URL=https://raw.githubusercontent.com/realpython/flask-microservices-swagger/master/swagger.json</span>
    <span class="l l-Scalar l-Scalar-Plain">depends_on</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">users-service</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">condition</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">service_started</span>
</code></pre></div>
<p>To test, commit your code and then push to GitHub. Make sure the build passes on Travis and that a new <a href="https://docs.docker.com/docker-hub/repos/#viewing-repository-tags">tag</a> was added to Docker Hub.</p>

<h4 id="users-db"><span style="font-family:'Montserrat', 'sans-serif';">Users DB</span></h4>

<p>For the users database, add the environment variables to <em>.travis.yml</em>:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">USERS_DB=flask-microservices-users_db</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">USERS_DB_REPO=https://github.com/realpython/$USERS.git#master:project/db</span>
</code></pre></div>
<p>Then add the following to <code>after_success</code>:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="c1"># users db</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker build $USERS_DB_REPO -t $USERS_DB:$COMMIT</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker tag $USERS_DB:$COMMIT $DOCKER_ID/$USERS_DB:$TAG</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker push $DOCKER_ID/$USERS_DB</span>
</code></pre></div>
<p>Commit, push, and ensure all is well.</p>

<p>For each of the next three services, we need to make the updates to <em>.travis.yml</em>, commit and push the code, and then ensure the build passes and the tag is added to Docker Hub....</p>

<h4 id="web"><span style="font-family:'Montserrat', 'sans-serif';">Web</span></h4>

<p>Environment variables:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">CLIENT=flask-microservices-client</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">CLIENT_REPO=https://github.com/realpython/$CLIENT.git</span>
</code></pre></div>
<p><code>after_success</code>:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="c1"># client</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker build $CLIENT_REPO -t $CLIENT:$COMMIT</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker tag $CLIENT:$COMMIT $DOCKER_ID/$CLIENT:$TAG</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker push $DOCKER_ID/$CLIENT</span>
</code></pre></div>
<h4 id="swagger"><span style="font-family:'Montserrat', 'sans-serif';">Swagger</span></h4>

<p>Environment variables:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">SWAGGER=flask-microservices-swagger</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">SWAGGER_REPO=https://github.com/realpython/$SWAGGER.git</span>
</code></pre></div>
<p><code>after_success</code>:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="c1"># swagger</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker build $SWAGGER_REPO -t $SWAGGER:$COMMIT</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker tag $SWAGGER:$COMMIT $DOCKER_ID/$SWAGGER:$TAG</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker push $DOCKER_ID/$SWAGGER</span>
</code></pre></div>
<h4 id="nginx"><span style="font-family:'Montserrat', 'sans-serif';">Nginx</span></h4>

<p>Environment variables:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">NGINX=flask-microservices-nginx</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">NGINX_REPO=https://github.com/realpython/flask-microservices-main.git#master:nginx</span>
</code></pre></div>
<p><code>after_success</code>:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="c1"># nginx</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker build $NGINX_REPO -t $NGINX:$COMMIT</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker tag $NGINX:$COMMIT $DOCKER_ID/$NGINX:$TAG</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">docker push $DOCKER_ID/$NGINX</span>
</code></pre></div>
<h4 id="scripts"><span style="font-family:'Montserrat', 'sans-serif';">Scripts</span></h4>

<p>Since we only want the <code>after_success</code> to run when the branch is <code>master</code>, let&#39;s create a simple shell script:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span></span><span class="ch">#!/bin/sh</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$TRAVIS_BRANCH</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;master&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  docker login -e <span class="nv">$DOCKER_EMAIL</span> -u <span class="nv">$DOCKER_ID</span> -p <span class="nv">$DOCKER_PASSWORD</span>
  <span class="nb">export</span> <span class="nv">TAG</span><span class="o">=</span><span class="sb">`</span><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$TRAVIS_BRANCH</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;master&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="nb">echo</span> <span class="s2">&quot;latest&quot;</span><span class="p">;</span> <span class="k">else</span> <span class="nb">echo</span> <span class="nv">$TRAVIS_BRANCH</span> <span class="p">;</span> <span class="k">fi</span><span class="sb">`</span>
  <span class="c1"># users</span>
  docker build <span class="nv">$USERS_REPO</span> -t <span class="nv">$USERS</span>:<span class="nv">$COMMIT</span>
  docker tag <span class="nv">$USERS</span>:<span class="nv">$COMMIT</span> <span class="nv">$DOCKER_ID</span>/<span class="nv">$USERS</span>:<span class="nv">$TAG</span>
  docker push <span class="nv">$DOCKER_ID</span>/<span class="nv">$USERS</span>
  <span class="c1"># users db</span>
  docker build <span class="nv">$USERS_DB_REPO</span> -t <span class="nv">$USERS_DB</span>:<span class="nv">$COMMIT</span>
  docker tag <span class="nv">$USERS_DB</span>:<span class="nv">$COMMIT</span> <span class="nv">$DOCKER_ID</span>/<span class="nv">$USERS_DB</span>:<span class="nv">$TAG</span>
  docker push <span class="nv">$DOCKER_ID</span>/<span class="nv">$USERS_DB</span>
  <span class="c1"># client</span>
  docker build <span class="nv">$CLIENT_REPO</span> -t <span class="nv">$CLIENT</span>:<span class="nv">$COMMIT</span>
  docker tag <span class="nv">$CLIENT</span>:<span class="nv">$COMMIT</span> <span class="nv">$DOCKER_ID</span>/<span class="nv">$CLIENT</span>:<span class="nv">$TAG</span>
  docker push <span class="nv">$DOCKER_ID</span>/<span class="nv">$CLIENT</span>
  <span class="c1"># swagger</span>
  docker build <span class="nv">$SWAGGER_REPO</span> -t <span class="nv">$SWAGGER</span>:<span class="nv">$COMMIT</span>
  docker tag <span class="nv">$SWAGGER</span>:<span class="nv">$COMMIT</span> <span class="nv">$DOCKER_ID</span>/<span class="nv">$SWAGGER</span>:<span class="nv">$TAG</span>
  docker push <span class="nv">$DOCKER_ID</span>/<span class="nv">$SWAGGER</span>
  <span class="c1"># nginx</span>
  docker build <span class="nv">$NGINX_REPO</span> -t <span class="nv">$NGINX</span>:<span class="nv">$COMMIT</span>
  docker tag <span class="nv">$NGINX</span>:<span class="nv">$COMMIT</span> <span class="nv">$DOCKER_ID</span>/<span class="nv">$NGINX</span>:<span class="nv">$TAG</span>
  docker push <span class="nv">$DOCKER_ID</span>/<span class="nv">$NGINX</span>
<span class="k">fi</span>
</code></pre></div>
<p>Save this as <em>docker_push.sh</em> within <em>flask-microservices-main</em>, and then update <code>after_success</code>:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="l l-Scalar l-Scalar-Plain">after_success</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">bash ./docker_push.sh</span>
</code></pre></div>
<p>We can speed up the building of new images by first pulling in the latest image from Docker Hub. Add a new script called <em>docker_build.sh</em> to the project root:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span></span><span class="ch">#!/bin/sh</span>

docker login -e <span class="nv">$DOCKER_EMAIL</span> -u <span class="nv">$DOCKER_ID</span> -p <span class="nv">$DOCKER_PASSWORD</span>
docker pull <span class="nv">$DOCKER_ID</span>/<span class="nv">$USERS</span>
docker pull <span class="nv">$DOCKER_ID</span>/<span class="nv">$USERS_DB</span>
docker pull <span class="nv">$DOCKER_ID</span>/<span class="nv">$CLIENT</span>
docker pull <span class="nv">$DOCKER_ID</span>/<span class="nv">$SWAGGER</span>
docker pull <span class="nv">$DOCKER_ID</span>/<span class="nv">$NGINX</span>

docker-compose -f docker-compose-ci.yml up -d --build
</code></pre></div>
<blockquote>
<p>Want to speed things up even more? <a href="https://github.com/start-jsk/jsk_apc/commit/7c12afa1c8c460f1b148c6ca887203d915fa9846">Cache images on Travis</a>.</p>
</blockquote>

<p>Update the <code>before_script</code> in <em>.travis.yml</em>:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span></span><span class="l l-Scalar l-Scalar-Plain">before_script</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">export TEST_URL=http://127.0.0.1</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">export REACT_APP_USERS_SERVICE_URL=http://127.0.0.1</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">export SECRET_KEY=my_precious</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">export DISPLAY=:99.0</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sh -e /etc/init.d/xvfb start</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sleep 3</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">bash ./docker_build.sh</span>
</code></pre></div>
<p>To test create a new branch feature branch and push your code to GitHub. A new build should be triggered, but it should not run any code within the <code>if</code> block within <em>docker_push.sh</em>. Merge your code to master in GitHub, which will trigger another new build on Travis. This time, the script should fire.</p>

<h4 id="architecture"><span style="font-family:'Montserrat', 'sans-serif';">Architecture</span></h4>

<table><thead>
<tr>
<th>Name</th>
<th>Repo</th>
<th>Image</th>
<th>Container</th>
<th>Tech</th>
</tr>
</thead><tbody>
<tr>
<td>Users API</td>
<td><a href="https://github.com/realpython/flask-microservices-users">users</a></td>
<td><a href="https://hub.docker.com/r/realpython/flask-microservices-users">users</a></td>
<td><code>users-service</code></td>
<td>Flask, gunicorn</td>
</tr>
<tr>
<td>Users DB</td>
<td><a href="https://github.com/realpython/flask-microservices-users/tree/master/project/db">users</a></td>
<td><a href="https://hub.docker.com/r/realpython/flask-microservices-users_db">users_db</a></td>
<td><code>users-db</code></td>
<td>Postgres</td>
</tr>
<tr>
<td>Client</td>
<td><a href="https://github.com/realpython/flask-microservices-client">client</a></td>
<td><a href="https://hub.docker.com/r/realpython/flask-microservices-client">client</a></td>
<td><code>web-service</code></td>
<td>React, React-Router</td>
</tr>
<tr>
<td>Swagger</td>
<td><a href="https://github.com/realpython/flask-microservices-swagger">swagger</a></td>
<td><a href="https://hub.docker.com/r/realpython/flask-microservices-swagger">swagger</a></td>
<td><code>swagger</code></td>
<td>Swagger UI</td>
</tr>
<tr>
<td>e2e Tests</td>
<td><a href="https://github.com/realpython/flask-microservices-main/tree/master/e2e">main</a></td>
<td>N/A</td>
<td>N/A</td>
<td>TestCafe</td>
</tr>
<tr>
<td>Nginx</td>
<td><a href="https://github.com/realpython/flask-microservices-main/tree/master/nginx">main</a></td>
<td><a href="https://hub.docker.com/r/realpython/flask-microservices-nginx">nginx</a></td>
<td><code>nginx</code></td>
<td>Nginx</td>
</tr>
</tbody></table>


          
  <br>
  <a class="twitter-share-button" data-show-count="false" href="https://twitter.com/intent/tweet?text=Microservices with Docker, Flask, and React - Docker Hub&amp;url=https%3A%2F%2Ftestdriven.io/part-five-docker-hub&amp;via=testdrivenio" rel="nofollow" target="_blank" title="Share on Twitter"></a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>



          <div class="page-nav">
            
            
          </div>

        </div>

      </div>
    </div>

     <footer class="page-footer white">
  <div class="container footer-container center-align">
    <ul>
      <li><small>Content by Michael Herman (michael@mherman.org)</small></li>
      <li><small>&copy; Copyright 2017 <a href="http://testdriven.io">TestDriven.io</a></small></li>
    </ul>
  </div>
</footer>


    <script type="text/javascript" src="//code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>

    
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-100160465-1', 'auto');
    ga('send', 'pageview');

  </script>



  </body>
</html>
